# -*- coding: utf-8 -*-
"""
Created on Mon Mar 28 15:04:27 2016

@author: jpeacock
"""

# ==============================================================================
#  Imports
# ==============================================================================

import copy
import sys
from pathlib import Path

try:
    from PyQt5 import QtCore, QtGui, QtWidgets
except ImportError:
    raise ImportError("This version needs PyQt5")

import numpy as np

from matplotlib.backends.backend_qt5agg import (
    FigureCanvasQTAgg as FigureCanvas,
)
from matplotlib.backends.backend_qt5agg import (
    NavigationToolbar2QT as NavigationToolbar,
)
from matplotlib.figure import Figure
import matplotlib.pyplot as plt
import matplotlib.gridspec as gridspec
import matplotlib.widgets as mplwidgets
from matplotlib.lines import Line2D
from matplotlib.collections import LineCollection

from mtpy import MT, MTData
import mtpy.analysis.staticshift as staticshift
from mtpy.imaging.mtplot_tools import plotters
from mtpy.imaging.mtplot_tools.utils import period_label_dict


# ==============================================================================
# UI
# ==============================================================================


class MyStream(QtCore.QObject):
    """
    this class will emit a signal to write standard output to the UI
    """

    message = QtCore.pyqtSignal(str)

    def __init__(self, parent=None):
        super(MyStream, self).__init__(parent)

    def write(self, message):
        self.message.emit(str(message))

    def flush(self):
        pass


class MTEditorWindow(QtWidgets.QMainWindow):
    """
    This is the main window for editing an mt file.

    Includes:
        * Editing points by removing them
        * Adjusting for static shift
        * Removing distortion
        * Rotations
        * Strike estimations
    """

    def __init__(self):
        self.file_types = ";;".join(
            [
                "*.edi",
                "*.mt",
                "*.zmm",
                "*.zrr",
                "*.zss",
                "*.avg",
                "*.j",
                "*.xml",
            ]
        )
        super(MTEditorWindow, self).__init__()

    def ui_setup(self):
        """
        set up the user interface
        """

        self.setWindowTitle("MT Editor")
        #        self.resize(1920, 1080)
        self.setWindowState(QtCore.Qt.WindowMaximized)

        self.plot_widget = PlotWidget()
        self.centralWidget = self.setCentralWidget(self.plot_widget)

        self.menu_file = self.menuBar().addMenu("&File")

        self.action_open_file = self.menu_file.addAction("&Open")
        self.action_open_file.triggered.connect(self.get_mt_file)

        self.action_close_file = self.menu_file.addAction("C&lose")
        self.action_close_file.triggered.connect(self.close_mt_file)

        self.action_save_file = self.menu_file.addAction("&Save")
        self.action_save_file.triggered.connect(self.save_mt_file)

        self.menu_plot_properties = self.menuBar().addMenu("Plot Properties")
        self.action_edit_plot = self.menu_plot_properties.addAction("Edit")
        self.action_edit_plot.triggered.connect(self.edit_plot_properties)

        self.menu_metadata = self.menuBar().addMenu("Metadata")
        # self.action_edit_metadata = self.menu_metadata.addAction("Edit")
        # self.action_edit_metadata.triggered.connect(self.edit_metadata)

        self.my_stream = MyStream()
        self.my_stream.message.connect(self.plot_widget.normal_output)

        sys.stdout = self.my_stream

        QtCore.QMetaObject.connectSlotsByName(self)

    def get_mt_file(self):
        """
        get mt file
        """

        print("=" * 35)
        fn_dialog = QtWidgets.QFileDialog()
        fn = Path(
            str(
                fn_dialog.getOpenFileNames(
                    caption="Choose MT file",
                    directory=self.plot_widget.dir_path.as_posix(),
                    filter=self.file_types,
                )[0][0]
            )
        )

        self.plot_widget.dir_path = fn.parent

        self.plot_widget.mt_obj = MT(fn)
        self.plot_widget.mt_obj.read()
        if self.plot_widget.mt_obj.elevation is None:
            self.plot_widget.mt_obj.elevation = 0.0
        self.plot_widget._mt_obj = MT(fn)
        self.plot_widget._mt_obj.read()
        self.plot_widget.fill_metadata()
        self.plot_widget.reset_parameters()
        self.plot_widget.plot_properties = PlotSettings(None)
        self.plot_widget.plot()

    def close_mt_file(self):
        pass

    def save_mt_file(self):
        save_fn_dialog = QtWidgets.QFileDialog()
        save_fn = Path(
            str(
                save_fn_dialog.getSaveFileName(
                    caption="Choose MT File",
                    directory=self.plot_widget.dir_path,
                    filter=self.file_types,
                )[0]
            )
        )

        self.mt_obj.write(fn=save_fn)

    def edit_plot_properties(self):
        self.plot_widget.plot_properties.setup_ui()
        self.plot_widget.plot_properties.show()
        self.plot_widget.plot_properties.settings_updated.connect(
            self.update_plot
        )

    def update_plot(self):

        self.mask_kw = {
            "color": self.plot_widget.plot_properties.mask_color,
            "marker": self.plot_widget.plot_properties.mask_marker,
            "ms": self.plot_widget.plot_properties.mask_ms,
            "mew": self.plot_widget.plot_properties.mask_mew,
        }
        self.plot_widget.redraw_plot()

    def edit_metadata(self):
        self.mt_text_editor = MTTextEditor(self.plot_widget.mt_obj)
        self.mt_text_editor.metadata_updated.connect(self.update_mt_metadata)

    def update_mt_metadata(self):
        self.plot_widget.mt_obj = copy.deepcopy(self.mt_text_editor.mt_obj)
        self.plot_widget.fill_metadata()


# ==============================================================================
# Plot Widget
# ==============================================================================
class PlotWidget(QtWidgets.QWidget):
    """
    matplotlib plot of the data

    """

    def __init__(self):
        super(PlotWidget, self).__init__()

        self.mt_obj = MT()
        self._mt_obj = MT()
        self.static_shift_x = 1.0
        self.static_shift_y = 1.0
        self.rotate_angle = 0
        self.plot_properties = PlotSettings(None)
        self._edited_ss = False
        self._edited_dist = False
        self._edited_rot = False
        self._edited_mask = False
        self._ax = None
        self.dir_path = Path().cwd()
        self.edits_mode = "Both"

        self.interp_period_min = 0.001
        self.interp_period_max = 1000.0
        self.interp_period_num = 24
        self.interp_type = "slinear"
        self.num_freq = None
        self.static_shift_med_rad = 2000.0
        self.static_shift_med_num_freq = 24
        self.mask_kw = {
            "color": self.plot_properties.mask_color,
            "marker": self.plot_properties.mask_marker,
            "ms": self.plot_properties.mask_ms,
            "mew": self.plot_properties.mask_mew,
        }

        self._interp_types = [
            "linear",
            "nearest",
            "zero",
            "slinear",
            "quadratic",
            "cubic",
        ]

        self.file_types = ";;".join(
            [
                "*.edi",
                "*.mt",
                "*.zmm",
                "*.zrr",
                "*.zss",
                "*.avg",
                "*.j",
                "*.xml",
            ]
        )

        self._z_output_dict = {0: "ex", 1: "ey"}
        self._input_dict = {0: "hx", 1: "hy"}
        self._t_output_dict = {0: "hz"}

        self.setup_ui()

    def setup_ui(self):
        """
        set up the ui
        """
        self.figure = Figure(dpi=150)
        self.mpl_widget = FigureCanvas(self.figure)
        self.mpl_widget.setFocusPolicy(QtCore.Qt.ClickFocus)
        self.mpl_widget.setFocus()

        # this will set the minimum width of the mpl plot, important to
        # resize everything
        screen = QtWidgets.QDesktopWidget().screenGeometry()
        self.mpl_widget.setMinimumWidth(screen.width() * 0.83)

        # be able to edit the data
        self.mpl_widget.mpl_connect("pick_event", self.on_pick)
        self.mpl_widget.mpl_connect("axes_enter_event", self.in_axes)
        self.mpl_widget.setSizePolicy(
            QtWidgets.QSizePolicy.Expanding, QtWidgets.QSizePolicy.Expanding
        )

        self.mpl_toolbar = NavigationToolbar(self.mpl_widget, self)

        # header label font
        header_font = QtGui.QFont()
        header_font.setBold = True
        header_font.setPointSize(14)

        button_font = QtGui.QFont()
        button_font.setBold = True
        button_font.setPointSize(11)

        # output box for all notes from the program
        self.output_label = QtWidgets.QLabel("Output")
        self.output_label.setFont(header_font)
        self.output_box = QtWidgets.QTextEdit()

        ## --> SET METADATA
        self.metadata_label = QtWidgets.QLabel("Metadata")
        self.metadata_label.setFont(header_font)

        self.meta_station_name_label = QtWidgets.QLabel("Station")
        self.meta_station_name_edit = QtWidgets.QLineEdit(
            str(self.mt_obj.station)
        )
        self.meta_station_name_edit.editingFinished.connect(
            self.meta_edit_station
        )

        # sets up with an empty mt object so we can set values to 0
        # once a mt is read in then the metadata will be filled.
        self.meta_lat_label = QtWidgets.QLabel("Lat (deg)")
        self.meta_lat_edit = QtWidgets.QLineEdit("{0:.6f}".format(0.0))
        self.meta_lat_edit.editingFinished.connect(self.meta_edit_lat)

        self.meta_lon_label = QtWidgets.QLabel("Long (deg)")
        self.meta_lon_edit = QtWidgets.QLineEdit("{0:.6f}".format(0.0))
        self.meta_lon_edit.editingFinished.connect(self.meta_edit_lon)

        self.meta_elev_label = QtWidgets.QLabel("Elev (m)")
        self.meta_elev_edit = QtWidgets.QLineEdit("{0:.3f}".format(0.0))
        self.meta_elev_edit.editingFinished.connect(self.meta_edit_elev)

        self.meta_loc_label = QtWidgets.QLabel("Location")
        self.meta_loc_edit = QtWidgets.QLineEdit("None")
        self.meta_loc_edit.editingFinished.connect(self.meta_edit_loc)

        self.meta_date_label = QtWidgets.QLabel("Date Acq")
        self.meta_date_edit = QtWidgets.QLineEdit("YYYY-MM-DD")
        self.meta_date_edit.editingFinished.connect(self.meta_edit_date)

        self.meta_acq_label = QtWidgets.QLabel("Acquired By")
        self.meta_acq_edit = QtWidgets.QLineEdit("None")
        self.meta_acq_edit.editingFinished.connect(self.meta_edit_acq)

        ## Static Shift
        self.static_shift_label = QtWidgets.QLabel("Static Shift")
        self.static_shift_label.setFont(header_font)

        self.static_shift_x_label = QtWidgets.QLabel("Shift X")
        self.static_shift_x_edit = QtWidgets.QLineEdit(
            "{0:.3f}".format(self.static_shift_x)
        )
        self.static_shift_x_edit.editingFinished.connect(
            self.static_shift_set_x
        )

        self.static_shift_y_label = QtWidgets.QLabel("Shift Y")
        self.static_shift_y_edit = QtWidgets.QLineEdit(
            "{0:.3f}".format(self.static_shift_y)
        )
        self.static_shift_y_edit.editingFinished.connect(
            self.static_shift_set_y
        )

        self.static_shift_apply_button = QtWidgets.QPushButton()
        self.static_shift_apply_button.setText("Apply Static Shift")
        self.static_shift_apply_button.setFont(button_font)
        self.static_shift_apply_button.setStyleSheet(
            "background-color: #c75e4d"
        )
        self.static_shift_apply_button.pressed.connect(self.static_shift_apply)

        self.static_shift_med_filt_button = QtWidgets.QPushButton()
        self.static_shift_med_filt_button.setText(
            "Estimate Spatial Mmtan Static Shift"
        )
        self.static_shift_med_filt_button.setFont(button_font)
        self.static_shift_med_filt_button.setStyleSheet(
            "background-color: #f9d7db"
        )
        self.static_shift_med_filt_button.pressed.connect(
            self.static_shift_med_filt_estimate
        )

        self.static_shift_med_rad_label = QtWidgets.QLabel(
            "Spatial Radius (m)"
        )
        self.static_shift_med_rad_edit = QtWidgets.QLineEdit(
            "{0:.2f}".format(self.static_shift_med_rad)
        )
        self.static_shift_med_rad_edit.editingFinished.connect(
            self.static_shift_med_rad_set
        )

        self.static_shift_med_num_freq_label = QtWidgets.QLabel(
            "Number of Frequencies"
        )
        self.static_shift_med_num_freq_edit = QtWidgets.QLineEdit()
        self.static_shift_med_num_freq_edit.setText(
            "{0}".format(self.static_shift_med_num_freq)
        )
        self.static_shift_med_num_freq_edit.editingFinished.connect(
            self.static_shift_med_num_freq_set
        )

        ## remove distortion
        self.remove_distortion_label = QtWidgets.QLabel("Remove Distortion")
        self.remove_distortion_label.setFont(header_font)

        self.remove_distortion_button = QtWidgets.QPushButton()
        self.remove_distortion_button.setText(
            "Remove Distortion [Bibby et al., 2005]"
        )
        self.remove_distortion_button.setStyleSheet(
            "background-color: #b8c3f5"
        )
        self.remove_distortion_button.setFont(button_font)
        self.remove_distortion_button.pressed.connect(
            self.remove_distortion_apply
        )

        self.remove_distortion_num_freq_label = QtWidgets.QLabel(
            "Number of Frequencies"
        )
        self.remove_distortion_num_freq_edit = QtWidgets.QLineEdit()
        if self.mt_obj.frequency is not None:
            self.remove_distortion_num_freq_edit.setText(
                "{0:.0f}".format(self.mt_obj.frequency.size)
            )
        self.remove_distortion_num_freq_edit.editingFinished.connect(
            self.remove_distortion_set_num_freq
        )
        ## rotate data
        self.rotate_data_label = QtWidgets.QLabel("Rotate")
        self.rotate_data_label.setFont(header_font)

        self.rotate_explanation = QtWidgets.QLabel(
            "Always rotating original data, assuming: N = 0, E = 90."
        )
        self.rotate_angle_label = QtWidgets.QLabel("Rotate (deg)")
        self.rotate_angle_edit = QtWidgets.QLineEdit(
            f"{self.rotate_angle:.4g}"
        )
        self.rotate_angle_edit.editingFinished.connect(self.rotate_set_angle)

        self.rotate_angle_button = QtWidgets.QPushButton("Apply Rotation")
        self.rotate_angle_button.setStyleSheet("background-color: #7dd4d0")
        self.rotate_angle_button.setFont(button_font)
        self.rotate_angle_button.pressed.connect(self.rotate_data_apply)

        self.rotate_estimate_strike_button = QtWidgets.QPushButton(
            "Estimate Strike"
        )
        self.rotate_estimate_strike_button.pressed.connect(
            self.rotate_estimate_strike
        )

        ## interpolate data
        self.interp_label = QtWidgets.QLabel("Interpolate Periods")
        self.interp_label.setFont(header_font)

        self.interp_apply_button = QtWidgets.QPushButton()
        self.interp_apply_button.setText("Apply Interpolation")
        self.interp_apply_button.setStyleSheet("background-color: #d39bd9")
        self.interp_apply_button.setFont(button_font)
        self.interp_apply_button.pressed.connect(self.interp_apply)

        self.interp_min_label = QtWidgets.QLabel("Min")
        self.interp_min_edit = QtWidgets.QLineEdit(
            "{0:.4e}".format(self.interp_period_min)
        )
        self.interp_min_edit.editingFinished.connect(self.interp_set_min)

        self.interp_max_label = QtWidgets.QLabel("Max")
        self.interp_max_edit = QtWidgets.QLineEdit(
            "{0:.4e}".format(self.interp_period_max)
        )
        self.interp_max_edit.editingFinished.connect(self.interp_set_max)

        self.interp_num_label = QtWidgets.QLabel("Num")
        self.interp_num_edit = QtWidgets.QLineEdit(
            "{0:.0f}".format(self.interp_period_num)
        )
        self.interp_num_edit.editingFinished.connect(self.interp_set_num)

        self.interp_type_label = QtWidgets.QLabel("Interp. Type")
        self.interp_type_combo = QtWidgets.QComboBox()
        self.interp_type_combo.addItems(self._interp_types)
        self.interp_type_combo.setCurrentIndex(3)
        self.interp_type_combo.currentIndexChanged.connect(
            self.interp_set_type
        )

        ## tools label
        self.tools_label = QtWidgets.QLabel("Editing Tools")
        self.tools_label.setFont(header_font)

        ## edit x, y or both
        self.edits_mode_label = QtWidgets.QLabel("Mode To Edit")
        self.edits_combo = QtWidgets.QComboBox()
        self.edits_combo.addItems(["Both", "X", "Y"])
        self.edits_combo.setFont(button_font)
        self.edits_combo.currentIndexChanged.connect(self.edits_set)

        ## apply edits button
        self.edits_apply_button = QtWidgets.QPushButton()
        self.edits_apply_button.setText("Apply Edits")
        self.edits_apply_button.setStyleSheet("background-color: #d99ba3")
        self.edits_apply_button.setFont(button_font)
        self.edits_apply_button.pressed.connect(self.edits_apply)

        ## revert back to original data
        self.revert_button = QtWidgets.QPushButton()
        self.revert_button.setText("Revert back to orginal data")
        self.revert_button.setStyleSheet("background-color: #c2d99b")
        self.revert_button.setFont(button_font)
        self.revert_button.pressed.connect(self.revert_back)

        ## save edits button
        self.save_edits_button = QtWidgets.QPushButton()
        self.save_edits_button.setText("Save Edits to new MT file")
        self.save_edits_button.setStyleSheet("background-color: #d9c59b")
        self.save_edits_button.setFont(button_font)
        self.save_edits_button.pressed.connect(self.save_mt_file)

        ## horizontal line
        h_line_01 = QtWidgets.QFrame(self)
        h_line_01.setFrameShape(QtWidgets.QFrame.HLine)
        h_line_01.setFrameShadow(QtWidgets.QFrame.Sunken)

        h_line_02 = QtWidgets.QFrame(self)
        h_line_02.setFrameShape(QtWidgets.QFrame.HLine)
        h_line_02.setFrameShadow(QtWidgets.QFrame.Sunken)

        h_line_03 = QtWidgets.QFrame(self)
        h_line_03.setFrameShape(QtWidgets.QFrame.HLine)
        h_line_03.setFrameShadow(QtWidgets.QFrame.Sunken)

        h_line_04 = QtWidgets.QFrame(self)
        h_line_04.setFrameShape(QtWidgets.QFrame.HLine)
        h_line_04.setFrameShadow(QtWidgets.QFrame.Sunken)

        h_line_05 = QtWidgets.QFrame(self)
        h_line_05.setFrameShape(QtWidgets.QFrame.HLine)
        h_line_05.setFrameShadow(QtWidgets.QFrame.Sunken)

        ## vertical spacer
        v_space = QtWidgets.QSpacerItem(
            20,
            20,
            QtWidgets.QSizePolicy.Minimum,
            QtWidgets.QSizePolicy.Maximum,
        )
        ###--> layout ---------------------------------------------
        ## mpl plot --> right panel
        mpl_vbox = QtWidgets.QVBoxLayout()
        mpl_vbox.addWidget(self.mpl_toolbar)
        mpl_vbox.addWidget(self.mpl_widget)

        ##--> Left Panel
        ## Metadata grid
        meta_layout = QtWidgets.QGridLayout()

        meta_layout.addWidget(self.metadata_label, 0, 0)
        meta_layout.addWidget(self.meta_station_name_label, 1, 0)
        meta_layout.addWidget(self.meta_station_name_edit, 1, 1)
        meta_layout.addWidget(self.meta_lat_label, 2, 0)
        meta_layout.addWidget(self.meta_lat_edit, 2, 1)
        meta_layout.addWidget(self.meta_lon_label, 3, 0)
        meta_layout.addWidget(self.meta_lon_edit, 3, 1)
        meta_layout.addWidget(self.meta_elev_label, 4, 0)
        meta_layout.addWidget(self.meta_elev_edit, 4, 1)
        meta_layout.addWidget(self.meta_loc_label, 5, 0)
        meta_layout.addWidget(self.meta_loc_edit, 5, 1)
        meta_layout.addWidget(self.meta_date_label, 6, 0)
        meta_layout.addWidget(self.meta_date_edit, 6, 1)
        meta_layout.addWidget(self.meta_acq_label, 7, 0)
        meta_layout.addWidget(self.meta_acq_edit, 7, 1)

        ## static shift
        ss_title = QtWidgets.QHBoxLayout()
        ss_title.addWidget(self.static_shift_label)
        ss_title.addWidget(self.static_shift_apply_button)

        ss_shift = QtWidgets.QHBoxLayout()
        ss_shift.addWidget(self.static_shift_x_label)
        ss_shift.addWidget(self.static_shift_x_edit)
        ss_shift.addWidget(self.static_shift_y_label)
        ss_shift.addWidget(self.static_shift_y_edit)

        ss_med = QtWidgets.QHBoxLayout()
        ss_med.addWidget(self.static_shift_med_rad_label)
        ss_med.addWidget(self.static_shift_med_rad_edit)
        ss_med.addWidget(self.static_shift_med_num_freq_label)
        ss_med.addWidget(self.static_shift_med_num_freq_edit)

        ss_layout = QtWidgets.QVBoxLayout()
        ss_layout.addLayout(ss_title)
        ss_layout.addLayout(ss_shift)
        ss_layout.addLayout(ss_med)
        ss_layout.addWidget(self.static_shift_med_filt_button)

        ## rotation
        rot_title = QtWidgets.QHBoxLayout()
        rot_title.addWidget(self.rotate_data_label)
        rot_title.addWidget(self.rotate_angle_button)

        rot_ang = QtWidgets.QHBoxLayout()
        rot_ang.addWidget(self.rotate_angle_label)
        rot_ang.addWidget(self.rotate_angle_edit)

        rot_layout = QtWidgets.QVBoxLayout()
        rot_layout.addLayout(rot_title)
        rot_layout.addWidget(self.rotate_explanation)
        rot_layout.addLayout(rot_ang)

        ## interpolate
        interp_title = QtWidgets.QHBoxLayout()
        interp_title.addWidget(self.interp_label)
        interp_title.addWidget(self.interp_apply_button)

        interp_num = QtWidgets.QGridLayout()
        interp_num.addWidget(self.interp_min_label, 0, 0)
        interp_num.addWidget(self.interp_min_edit, 0, 1)
        interp_num.addWidget(self.interp_max_label, 0, 2)
        interp_num.addWidget(self.interp_max_edit, 0, 3)

        interp_num.addWidget(self.interp_num_label, 1, 0)
        interp_num.addWidget(self.interp_num_edit, 1, 1)
        interp_num.addWidget(self.interp_type_label, 1, 2)
        interp_num.addWidget(self.interp_type_combo, 1, 3)

        interp_layout = QtWidgets.QVBoxLayout()
        interp_layout.addLayout(interp_title)
        interp_layout.addLayout(interp_num)

        dis_hbox = QtWidgets.QHBoxLayout()
        dis_hbox.addWidget(self.remove_distortion_num_freq_label)
        dis_hbox.addWidget(self.remove_distortion_num_freq_edit)

        edit_layout = QtWidgets.QGridLayout()
        edit_layout.addWidget(self.tools_label, 0, 0, 1, 2)
        edit_layout.addWidget(self.edits_mode_label, 1, 0)
        edit_layout.addWidget(self.edits_combo, 1, 1)
        edit_layout.addWidget(self.edits_apply_button, 2, 0, 1, 2)
        edit_layout.addWidget(self.revert_button, 3, 0, 1, 2)
        edit_layout.addWidget(self.save_edits_button, 4, 0, 1, 2)

        ## left panel
        info_layout = QtWidgets.QVBoxLayout()
        info_layout.addLayout(meta_layout)

        info_layout.addWidget(h_line_01)
        info_layout.addWidget(self.remove_distortion_label)
        info_layout.addWidget(self.remove_distortion_button)
        info_layout.addLayout(dis_hbox)
        info_layout.addWidget(h_line_02)
        info_layout.addLayout(ss_layout)
        info_layout.addWidget(h_line_03)
        info_layout.addLayout(rot_layout)
        info_layout.addWidget(h_line_04)
        info_layout.addLayout(interp_layout)
        info_layout.addWidget(h_line_05)
        info_layout.addLayout(edit_layout)
        info_layout.addItem(v_space)
        info_layout.addWidget(self.output_label)
        info_layout.addWidget(self.output_box)

        ## final layout
        final_layout = QtWidgets.QHBoxLayout()
        final_layout.addLayout(info_layout)
        final_layout.addLayout(mpl_vbox)

        self.setLayout(final_layout)
        self.mpl_widget.updateGeometry()

    def meta_edit_station(self):
        self.mt_obj.station = str(self.meta_station_name_edit.text())

    def meta_edit_lat(self):
        self.mt_obj.latitude = float(str(self.meta_lat_edit.text()))
        self.meta_lat_edit.setText("{0:.6f}".format(self.mt_obj.latitude))

    def meta_edit_lon(self):
        self.mt_obj.longitude = float(str(self.meta_lon_edit.text()))
        self.meta_lon_edit.setText("{0:.6f}".format(self.mt_obj.longitude))

    def meta_edit_elev(self):
        self.mt_obj.elevation = float(str(self.meta_elev_edit.text()))
        self.meta_elev_edit.setText("{0:.6f}".format(self.mt_obj.elevation))

    def meta_edit_loc(self):
        self.mt_obj.station_metadata.geographic_name = str(
            self.meta_loc_edit.text()
        )
        self.meta_loc_edit.setText(
            "{0}".format(self.mt_obj.station_metadata.geographic_name)
        )

    def meta_edit_date(self):
        self.mt_obj.station_metadata.provenance.creation_time = str(
            self.meta_date_edit.text()
        )
        self.meta_date_edit.setText(
            self.mt_obj.station_metadata.provenance.creation_time
        )

    def meta_edit_acq(self):
        self.mt_obj.station_metadata.acquired_by.author = str(
            self.meta_acq_edit.text()
        )
        self.meta_acq_edit.setText(
            self.mt_obj.station_metadata.acquired_by.author
        )

    def fill_metadata(self):
        self.meta_station_name_edit.setText(self.mt_obj.station)
        self.meta_lat_edit.setText("{0:.6f}".format(self.mt_obj.latitude))
        self.meta_lon_edit.setText("{0:.6f}".format(self.mt_obj.longitude))
        try:
            self.meta_elev_edit.setText(
                "{0:.6f}".format(self.mt_obj.elevation)
            )
        except ValueError:
            self.mt_obj.elevation = 0.0
            self.meta_elev_edit.setText(
                "{0:.6f}".format(self.mt_obj.elevation)
            )
        self.meta_date_edit.setText(
            "{0}".format(self.mt_obj.station_metadata.provenance.creation_time)
        )
        self.meta_loc_edit.setText(
            "{0}".format(self.mt_obj.station_metadata.geographic_name)
        )
        self.meta_acq_edit.setText(
            "{0}".format(self.mt_obj.station_metadata.acquired_by.author)
        )
        self.remove_distortion_num_freq_edit.setText(
            "{0:.0f}".format(self.mt_obj.frequency.size)
        )

    def static_shift_set_x(self):
        self.static_shift_x = float(str(self.static_shift_x_edit.text()))
        self.static_shift_x_edit.setText("{0:.5g}".format(self.static_shift_x))

    def static_shift_set_y(self):
        self.static_shift_y = float(str(self.static_shift_y_edit.text()))
        self.static_shift_y_edit.setText("{0:.5g}".format(self.static_shift_y))

    def static_shift_apply(self):
        """
        shift apparent resistivity up or down
        """
        if (
            self._edited_dist == False
            and self._edited_rot == False
            and self._edited_mask == False
        ):
            # be sure to apply the static shift to the original data
            self.mt_obj = self._mt_obj.remove_static_shift(
                ss_x=self.static_shift_x, ss_y=self.static_shift_y
            )
            # print the static shift applied
            print("\n    Static shift applied to original data:")
        else:
            self.mt_obj = self.mt_obj.remove_static_shift(
                ss_x=self.static_shift_x, ss_y=self.static_shift_y
            )
            # print the static shift applied
            print("\n    - Static shift applied to edited data:")

        # print the static shift applied
        print(
            "        x = {0:<8.5g}, y = {1:<8.5g}".format(
                self.static_shift_x, self.static_shift_y
            )
        )
        self._edited_ss = True

        self.redraw_plot()

    def static_shift_med_rad_set(self):
        self.static_shift_med_rad = float(
            str(self.static_shift_med_rad_edit.text())
        )
        self.static_shift_med_rad_edit.setText(
            "{0:.2f}".format(self.static_shift_med_rad)
        )

    def static_shift_med_num_freq_set(self):
        self.static_shift_med_num_freq = float(
            str(self.static_shift_med_num_freq_edit.text())
        )
        self.static_shift_med_num_freq_edit.setText(
            "{0:.0f}".format(self.static_shift_med_num_freq)
        )

    def static_shift_med_filt_estimate(self):

        ss_x, ss_y = staticshift.estimate_static_spatial_mmtan(
            self.mt_obj.fn,
            radius=self.static_shift_med_rad,
            num_freq=self.static_shift_med_num_freq,
        )

        self.static_shift_x = ss_x
        self.static_shift_y = ss_y

        self.static_shift_x_edit.setText("{0:.5g}".format(ss_x))
        self.static_shift_y_edit.setText("{0:.5g}".format(ss_y))

    def remove_distortion_set_num_freq(self):
        """
        set number of frequencies to remove distortion from
        """

        try:
            self.num_freq = int(
                str(self.remove_distortion_num_freq_edit.text())
            )
            self.remove_distortion_num_freq_edit.setText(
                "{0:.0f}".format(self.num_freq)
            )
        except ValueError:
            self.num_freq = None

    def remove_distortion_apply(self):
        """
        remove distortion from the mt repsonse
        """
        if (
            self._edited_dist == False
            and self._edited_rot == False
            and self._edited_mask == False
            and self._edited_ss == False
        ):
            # remove distortion from original data
            self.mt_obj = self._mt_obj.remove_distortion(
                num_freq=self.num_freq
            )
            print("\n    - Removed distortion from original data")

        else:
            # remove distortion from edited data
            self.mt_obj = self.mt_obj.remove_distortion(
                n_frequencies=self.num_freq
            )
            print("\n    - Removed distortion from edited data")

        self._edited_dist = True

        self.redraw_plot()

    def rotate_set_angle(self):
        """
        set z rotation angle

        Always rotate original data otherwiswe can get messy
        """
        self.rotate_z_angle = float(str(self.rotate_angle_edit.text()))
        self.rotate_angle_z_edit.setText("{0:.4f}".format(self.rotate_angle))

        self.rotate_tip_angle = float(self.rotate_z_angle)
        self.rotate_angle_t_edit.setText(
            "{0:.4f}".format(self.rotate_tip_angle)
        )

    def rotate_data_apply(self):
        """
        rotate both Z and tipper original data by the input angles
        """

        self.mt_obj = self._mt_obj.rotate(self.rotate_angle)

        if self._edited_ss == True:
            self.static_shift_apply()

        if self._edited_dist == True:
            self.remove_distortion_apply()

        self.redraw_plot()

        self._edited_rot = True

        print(f"\n   Rotated orginal data clockwise by: {self.rotate_angle}")

    def rotate_estimate_strike(self):
        """
        estimate strike from the invariants, phase tensor, and tipper if
        measured.
        """
        md = MTData()
        md.add_station(self.mt_obj)

        md.plot_strike(plot_type=1)

    def interp_set_min(self):
        self.interp_period_min = float(str(self.interp_min_edit.text()))
        self.interp_min_edit.setText(f"{self.interp_period_min:.4e}")

    def interp_set_max(self):
        self.interp_period_max = float(str(self.interp_max_edit.text()))
        self.interp_max_edit.setText(f"{self.interp_period_max:.4e}")

    def interp_set_num(self):
        self.interp_period_num = int(str(self.interp_num_edit.text()))
        self.interp_num_edit.setText(f"{self.interp_period_num:.0f}")

    def interp_set_type(self, selected_item):
        self.interp_type = self._interp_types[selected_item]

    def interp_apply(self):
        """
        interpolate data on to a new period list that is equally spaced in
        log space.
        """

        new_period = np.logspace(
            np.log10(self.interp_period_min),
            np.log10(self.interp_period_max),
            num=self.interp_period_num,
        )
        interp_freq = 1.0 / new_period
        interp_idx = np.where(
            (interp_freq >= self.mt_obj.frequency.min())
            & (interp_freq <= self.mt_obj.frequency.max())
        )

        interp_freq = interp_freq[interp_idx]
        if len(interp_idx) != len(new_period):

            info = [
                "Cannot interpolate over periods not represented in the data.",
                f"Data min = {1.0 / self.mt_obj.frequency.max():<8.3e} s",
                f"Data max = {1.0 / self.mt_obj.frequency.min():<8.3e} s",
                "",
                "Given period range:",
                f"     min = {new_period.min():<8.3e} s",
                f"     max = {new_period.max():<8.3e} s",
                "",
                "Setting interpolation frequency bounds to:",
                f"     min = {1.0 / interp_freq.max():<8.3e} s",
                f"     max = {1.0 / interp_freq.min():<8.3e} s",
            ]

            print("\n".join(info))

        if (
            self._edited_dist == True
            or self._edited_mask == True
            or self._edited_rot == True
            or self._edited_ss == True
        ):
            self.mt_obj = self.mt_obj.interpolate(
                interp_freq, method=self.interp_type
            )

        else:
            self.mt_obj = self._mt_obj.interpolate(
                interp_freq, method=self.interp_type
            )

        self.redraw_plot()

    def edits_set(self, selected_item):
        modes_list = ["Both", "X", "Y"]
        self.edits_mode = modes_list[selected_item]

    def edits_apply(self):
        """
        apply edits, well edits are already made, but replot without edited
        points
        """

        self.redraw_plot()

    def revert_back(self):
        """
        revert back to original data

        """

        self.mt_obj = MT(self._mt_obj.fn)
        self.mt_obj.read()
        self.reset_parameters()
        self.redraw_plot()

        print("\n")
        print("-" * 35)
        print("Reverted back to original input data.")
        print("Reset editing parameters.")

    def reset_parameters(self):
        self.static_shift_x = 1.0
        self.static_shift_y = 1.0
        self.static_shift_x_edit.setText(f"{self.static_shift_x:.4g}")
        self.static_shift_y_edit.setText(f"{self.static_shift_y:.4g}")
        self.rotate_z_angle = 0.0
        self.rotate_tip_angle = 0.0
        self.rotate_angle_edit.setText(f"{self.rotate_angle:.4g}")

        self._edited_ss = False
        self._edited_dist = False
        self._edited_rot = False

    def save_mt_file(self):
        """
        save edited mt file to the chosen file name.
        """

        save_dialog = QtWidgets.QFileDialog()
        save_fn = Path(
            str(
                save_dialog.getSaveFileName(
                    caption="Choose MT file",
                    directory=self._mt_obj.fn.parent.as_posix(),
                    filter=self.file_types,
                )[0]
            )
        )
        self.mt_obj.write(save_fn)

    @QtCore.pyqtSlot(str)
    def normal_output(self, message):
        self.output_box.moveCursor(QtGui.QTextCursor.End)
        self.output_box.insertPlainText(message)

    def plot(self):
        """
        plot the response

        will have original data below the editable data
        """

        self.figure.clf()

        self.figure.suptitle(
            self.mt_obj.station,
            fontdict={"size": self.plot_properties.fs + 4, "weight": "bold"},
        )

        # make some useful internal variabls
        font_dict = {"size": self.plot_properties.fs + 2, "weight": "bold"}
        plot_period = self.mt_obj.period
        plot_period_o = self._mt_obj.period

        if not self.mt_obj.has_tipper():
            print("No Tipper data for station {0}".format(self.mt_obj.station))
            self.plot_tipper = False
        else:
            self.plot_tipper = True

        # set x-axis limits from short period to long period
        self.plot_properties.xlimits = (
            10 ** (np.floor(np.log10(plot_period_o.min()))),
            10 ** (np.ceil(np.log10((plot_period_o.max())))),
        )

        # --> make key word dictionaries for plotting
        kw_xx = {
            "color": self.plot_properties.cted,
            "mec": self.plot_properties.cted,
            "ecolor": self.plot_properties.cted,
            "marker": self.plot_properties.mted,
            "ms": self.plot_properties.ms,
            "ls": ":",
            "lw": self.plot_properties.lw,
            "capsize": self.plot_properties.e_capsize,
            "capthick": self.plot_properties.e_capthick,
            "picker": 3,
        }

        kw_yy = {
            "color": self.plot_properties.ctmd,
            "mec": self.plot_properties.ctmd,
            "ecolor": self.plot_properties.ctmd,
            "marker": self.plot_properties.mtmd,
            "ms": self.plot_properties.ms,
            "ls": ":",
            "lw": self.plot_properties.lw,
            "capsize": self.plot_properties.e_capsize,
            "capthick": self.plot_properties.e_capthick,
            "picker": 3,
        }

        kw_xx_o = {
            "color": self.plot_properties.cteo,
            "mec": self.plot_properties.cteo,
            "ecolor": self.plot_properties.cteo,
            "marker": self.plot_properties.mted,
            "ms": self.plot_properties.ms,
            "ls": ":",
            "lw": self.plot_properties.lw,
            "capsize": self.plot_properties.e_capsize,
            "capthick": self.plot_properties.e_capthick,
            "picker": None,
        }

        kw_yy_o = {
            "color": self.plot_properties.ctmo,
            "mec": self.plot_properties.ctmo,
            "ecolor": self.plot_properties.ctmo,
            "marker": self.plot_properties.mtmd,
            "ms": self.plot_properties.ms,
            "ls": ":",
            "lw": self.plot_properties.lw,
            "capsize": self.plot_properties.e_capsize,
            "capthick": self.plot_properties.e_capthick,
            "picker": None,
        }

        # create a grid of subplots
        gs = gridspec.GridSpec(3, 2, height_ratios=[2, 1.5, 1])

        gs.update(
            hspace=self.plot_properties.subplot_hspace,
            wspace=self.plot_properties.subplot_wspace,
            left=self.plot_properties.subplot_left,
            right=self.plot_properties.subplot_right,
            top=self.plot_properties.subplot_top,
            bottom=self.plot_properties.subplot_bottom,
        )

        # find locations where points have been masked
        nzxx = np.nonzero(self.mt_obj.Z.z[:, 0, 0])[0]
        nzxy = np.nonzero(self.mt_obj.Z.z[:, 0, 1])[0]
        nzyx = np.nonzero(self.mt_obj.Z.z[:, 1, 0])[0]
        nzyy = np.nonzero(self.mt_obj.Z.z[:, 1, 1])[0]

        nzxx_o = np.nonzero(self._mt_obj.Z.z[:, 0, 0])[0]
        nzxy_o = np.nonzero(self._mt_obj.Z.z[:, 0, 1])[0]
        nzyx_o = np.nonzero(self._mt_obj.Z.z[:, 1, 0])[0]
        nzyy_o = np.nonzero(self._mt_obj.Z.z[:, 1, 1])[0]

        # make axis od = off-diagonal, d = diagonal, share x axis across plots
        self.ax_res_od = self.figure.add_subplot(gs[0, 0])
        self.ax_res_d = self.figure.add_subplot(
            gs[0, 1], sharex=self.ax_res_od
        )

        self.ax_phase_od = self.figure.add_subplot(
            gs[1, 0], sharex=self.ax_res_od
        )
        self.ax_phase_d = self.figure.add_subplot(
            gs[1, 1], sharex=self.ax_res_od
        )

        # include tipper, r = real, i = imaginary
        self.ax_tip_x = self.figure.add_subplot(
            gs[2, 0], sharex=self.ax_res_od
        )
        self.ax_tip_y = self.figure.add_subplot(
            gs[2, 1], sharex=self.ax_res_od
        )

        self.ax_list = [
            self.ax_res_od,
            self.ax_res_d,
            self.ax_phase_od,
            self.ax_phase_d,
            self.ax_tip_x,
            self.ax_tip_y,
        ]

        self._ax = self.ax_res_od

        ## --> plot apparent resistivity, phase and tipper
        ## plot orginal apparent resistivity
        if self.plot_properties.plot_original_data == True:
            orxx = plotters.plot_errorbar(
                self.ax_res_d,
                plot_period_o[nzxx_o],
                self._mt_obj.Z.resistivity[nzxx_o, 0, 0],
                self._mt_obj.Z.resistivity_error[nzxx_o, 0, 0],
                **kw_xx_o,
            )
            orxy = plotters.plot_errorbar(
                self.ax_res_od,
                plot_period_o[nzxy_o],
                self._mt_obj.Z.resistivity[nzxy_o, 0, 1],
                self._mt_obj.Z.resistivity_error[nzxy_o, 0, 1],
                **kw_xx_o,
            )
            oryx = plotters.plot_errorbar(
                self.ax_res_od,
                plot_period_o[nzyx_o],
                self._mt_obj.Z.resistivity[nzyx_o, 1, 0],
                self._mt_obj.Z.resistivity_error[nzyx_o, 1, 0],
                **kw_yy_o,
            )
            oryy = plotters.plot_errorbar(
                self.ax_res_d,
                plot_period_o[nzyy_o],
                self._mt_obj.Z.resistivity[nzyy_o, 1, 1],
                self._mt_obj.Z.resistivity_error[nzyy_o, 1, 1],
                **kw_yy_o,
            )
            # plot original phase
            epxx = plotters.plot_errorbar(
                self.ax_phase_d,
                plot_period_o[nzxx_o],
                self._mt_obj.Z.phase[nzxx_o, 0, 0],
                self._mt_obj.Z.phase_error[nzxx_o, 0, 0],
                **kw_xx_o,
            )
            epxy = plotters.plot_errorbar(
                self.ax_phase_od,
                plot_period_o[nzxy_o],
                self._mt_obj.Z.phase[nzxy_o, 0, 1],
                self._mt_obj.Z.phase_error[nzxy_o, 0, 1],
                **kw_xx_o,
            )
            epyx = plotters.plot_errorbar(
                self.ax_phase_od,
                plot_period_o[nzyx_o],
                self._mt_obj.Z.phase[nzyx_o, 1, 0] + 180,
                self._mt_obj.Z.phase_error[nzyx_o, 1, 0],
                **kw_yy_o,
            )
            epyy = plotters.plot_errorbar(
                self.ax_phase_d,
                plot_period_o[nzyy_o],
                self._mt_obj.Z.phase[nzyy_o, 1, 1],
                self._mt_obj.Z.phase_error[nzyy_o, 1, 1],
                **kw_yy_o,
            )

        # plot manipulated data apparent resistivity
        erxx = plotters.plot_errorbar(
            self.ax_res_d,
            plot_period[nzxx],
            self.mt_obj.Z.resistivity[nzxx, 0, 0],
            self.mt_obj.Z.resistivity_error[nzxx, 0, 0],
            **kw_xx,
        )
        erxy = plotters.plot_errorbar(
            self.ax_res_od,
            plot_period[nzxy],
            self.mt_obj.Z.resistivity[nzxy, 0, 1],
            self.mt_obj.Z.resistivity_error[nzxy, 0, 1],
            **kw_xx,
        )
        eryx = plotters.plot_errorbar(
            self.ax_res_od,
            plot_period[nzyx],
            self.mt_obj.Z.resistivity[nzyx, 1, 0],
            self.mt_obj.Z.resistivity_error[nzyx, 1, 0],
            **kw_yy,
        )
        eryy = plotters.plot_errorbar(
            self.ax_res_d,
            plot_period[nzyy],
            self.mt_obj.Z.resistivity[nzyy, 1, 1],
            self.mt_obj.Z.resistivity_error[nzyy, 1, 1],
            **kw_yy,
        )

        # --> set axes properties for apparent resistivity
        if self.plot_properties.res_limits_d != None:
            self.ax_res_d.set_ylim(self.plot_properties.res_limits_d)
        if self.plot_properties.res_limits_od != None:
            self.ax_res_od.set_ylim(self.plot_properties.res_limits_od)
        for aa, ax in enumerate([self.ax_res_od, self.ax_res_d]):
            plt.setp(ax.get_xticklabels(), visible=False)
            if aa == 0:
                ax.set_ylabel(
                    "App. Res. ($\mathbf{\Omega \cdot m}$)", fontdict=font_dict
                )
            ax.set_yscale("log", nonpositive="clip")
            ax.set_xscale("log", nonpositive="clip")
            ax.set_xlim(self.plot_properties.xlimits)

            ax.grid(
                True,
                alpha=0.25,
                which="both",
                color=(0.25, 0.25, 0.25),
                lw=0.25,
            )
            # make the plot cleaner by removing the bottom x label
            ylim = ax.get_ylim()
            ylimits = (
                10 ** np.floor(np.log10(ylim[0])),
                10 ** np.ceil(np.log10(ylim[1])),
            )
            ax.set_ylim(ylimits)
            ylabels = [" ", " "] + [
                period_label_dict[ii]
                for ii in np.arange(
                    np.log10(ylimits[0]) + 1, np.log10(ylimits[1]) + 1, 1
                )
            ]
            ax.set_yticklabels(ylabels)

        self.ax_res_od.legend(
            (erxy[0], eryx[0]),
            ("$Z_{xy}$", "$Z_{yx}$"),
            loc=3,
            markerscale=1,
            borderaxespad=0.01,
            labelspacing=0.07,
            handletextpad=0.2,
            borderpad=0.02,
        )
        self.ax_res_d.legend(
            (erxx[0], eryy[0]),
            ("$Z_{xx}$", "$Z_{yy}$"),
            loc=3,
            markerscale=1,
            borderaxespad=0.01,
            labelspacing=0.07,
            handletextpad=0.2,
            borderpad=0.02,
        )

        ##--> plot phase
        # plot manipulated data
        epxx = plotters.plot_errorbar(
            self.ax_phase_d,
            plot_period[nzxx],
            self.mt_obj.Z.phase[nzxx, 0, 0],
            self.mt_obj.Z.phase_error[nzxx, 0, 0],
            **kw_xx,
        )
        epxy = plotters.plot_errorbar(
            self.ax_phase_od,
            plot_period[nzxy],
            self.mt_obj.Z.phase[nzxy, 0, 1],
            self.mt_obj.Z.phase_error[nzxy, 0, 1],
            **kw_xx,
        )
        epyx = plotters.plot_errorbar(
            self.ax_phase_od,
            plot_period[nzyx],
            self.mt_obj.Z.phase[nzyx, 1, 0] + 180,
            self.mt_obj.Z.phase_error[nzyx, 1, 0],
            **kw_yy,
        )
        epyy = plotters.plot_errorbar(
            self.ax_phase_d,
            plot_period[nzyy],
            self.mt_obj.Z.phase[nzyy, 1, 1],
            self.mt_obj.Z.phase_error[nzyy, 1, 1],
            **kw_yy,
        )

        # --> set axes properties
        if self.plot_properties.phase_limits_od != None:
            self.ax_phase_od.set_ylim(self.plot_properties.phase_limits_od)
        else:
            self.ax_phase_od.set_ylim((-5, 100))
        if self.plot_properties.phase_limits_d != None:
            self.ax_phase_d.set_ylim(self.plot_properties.phase_limits_d)
        for aa, ax in enumerate([self.ax_phase_od, self.ax_phase_d]):
            ax.set_xlabel("Period (s)", font_dict)
            ax.set_xscale("log", nonpositive="clip")
            if aa == 0:
                ax.set_ylabel("Phase (deg)", font_dict)
                # ax.yaxis.set_major_locator(MultipleLocator(15))
                # ax.yaxis.set_minor_locator(MultipleLocator(5))
            ax.grid(
                True,
                alpha=0.25,
                which="both",
                color=(0.25, 0.25, 0.25),
                lw=0.25,
            )

        # set the last label to be an empty string for easier reading
        for ax in [self.ax_phase_od, self.ax_phase_d]:
            for label in [ax.get_yticklabels()[0], ax.get_yticklabels()[-1]]:
                label.set_visible(False)

        ## --> plot tipper
        # set th xaxis tick labels to invisible
        plt.setp(self.ax_phase_od.xaxis.get_ticklabels(), visible=False)
        plt.setp(self.ax_phase_d.xaxis.get_ticklabels(), visible=False)
        self.ax_phase_od.set_xlabel("")
        self.ax_phase_d.set_xlabel("")

        # make sure there is tipper data to plot
        if self.plot_tipper == True:

            kw_tx = dict(kw_xx)
            kw_ty = dict(kw_yy)
            kw_tx["color"] = self.plot_properties.tipper_x_color
            kw_ty["color"] = self.plot_properties.tipper_y_color

            ntx = np.nonzero(self.mt_obj.Tipper.amplitude[:, 0, 0])[0]
            nty = np.nonzero(self.mt_obj.Tipper.amplitude[:, 0, 1])[0]
            ntx_o = np.nonzero(self._mt_obj.Tipper.amplitude[:, 0, 0])[0]
            nty_o = np.nonzero(self._mt_obj.Tipper.amplitude[:, 0, 1])[0]

            # plot magnitude of real and imaginary induction vectors
            if self.plot_properties.plot_original_data == True:
                etxo = plotters.plot_errorbar(
                    self.ax_tip_x,
                    plot_period_o[ntx_o],
                    self._mt_obj.Tipper.amplitude[ntx_o, 0, 0],
                    self._mt_obj.Tipper.amplitude_error[ntx_o, 0, 0],
                    **kw_xx_o,
                )

                etyo = plotters.plot_errorbar(
                    self.ax_tip_y,
                    plot_period_o[nty_o],
                    self._mt_obj.Tipper.amplitude[nty_o, 0, 1],
                    self._mt_obj.Tipper.amplitude_error[nty_o, 0, 1],
                    **kw_yy_o,
                )

            # plot magnitude of edited induction vectors
            etx = plotters.plot_errorbar(
                self.ax_tip_x,
                plot_period[ntx],
                self.mt_obj.Tipper.amplitude[ntx, 0, 0],
                self.mt_obj.Tipper.amplitude_error[ntx, 0, 0],
                **kw_tx,
            )

            ety = plotters.plot_errorbar(
                self.ax_tip_y,
                plot_period[nty],
                self.mt_obj.Tipper.amplitude[nty, 0, 1],
                self.mt_obj.Tipper.amplitude_error[nty, 0, 1],
                **kw_ty,
            )

            self.ax_tip_x.legend(
                [etx[0]],
                ["|Re{T}|"],
                loc=2,
                markerscale=1,
                borderaxespad=0.01,
                handletextpad=0.2,
                borderpad=0.05,
            )
            self.ax_tip_y.legend(
                [ety[0]],
                ["|Im{T}|"],
                loc=2,
                markerscale=1,
                borderaxespad=0.01,
                handletextpad=0.2,
                borderpad=0.05,
            )

        # --> set axes properties for magnitude and angle of induction vectors
        if self.plot_properties.tipper_x_limits != None:
            self.ax_tip_x.set_ylim(self.plot_properties.tipper_x_limits)
        else:
            self.ax_tip_x.set_ylim((0, 1))
        if self.plot_properties.tipper_y_limits != None:
            self.ax_tip_y.set_ylim(self.plot_properties.tipper_y_limits)
        else:
            self.ax_tip_y.set_ylim((0, 1))
        for aa, ax in enumerate([self.ax_tip_x, self.ax_tip_y]):
            if aa == 0:
                ax.set_ylabel("Magnitude", fontdict=font_dict)

            ax.set_xscale("log", nonpositive="clip")
            ax.grid(
                True,
                alpha=0.25,
                which="both",
                color=(0.25, 0.25, 0.25),
                lw=0.25,
            )

        # set the last label to be an empty string for easier reading
        for ax in [self.ax_tip_x, self.ax_tip_y]:
            for label in [ax.get_yticklabels()[-1]]:
                label.set_visible(False)

        # gs.tight_layout(self.figure, h_pad=0)

        ## --> make a rectangluar picker box
        self.rs_od_res = mplwidgets.RectangleSelector(
            self.ax_res_od,
            self.rect_onselect_od,
            useblit=True,
            interactive=True,
            button=[1],
        )
        self.rs_d_res = mplwidgets.RectangleSelector(
            self.ax_res_d,
            self.rect_onselect_d,
            useblit=True,
            interactive=True,
            button=[1],
        )
        self.rs_od_phs = mplwidgets.RectangleSelector(
            self.ax_phase_od,
            self.rect_onselect_od,
            useblit=True,
            interactive=True,
            button=[1],
        )
        self.rs_d_phs = mplwidgets.RectangleSelector(
            self.ax_phase_d,
            self.rect_onselect_d,
            useblit=True,
            interactive=True,
            button=[1],
        )
        self.rs_tr = mplwidgets.RectangleSelector(
            self.ax_tip_x,
            self.rect_onselect_tr,
            useblit=True,
            interactive=True,
            button=[1],
        )
        self.rs_ti = mplwidgets.RectangleSelector(
            self.ax_tip_y,
            self.rect_onselect_ti,
            useblit=True,
            interactive=True,
            button=[1],
        )

        ## --> need to be sure to draw the figure
        self.mpl_widget.draw()

    def redraw_plot(self):
        self.plot()

    def on_pick(self, event):
        """
        mask a data point when it is clicked on.
        """

        if isinstance(event.artist, Line2D):
            # line_collection = event.artist
            data_point = event.artist
            data_period = data_point.get_xdata()[event.ind]
            data_value = data_point.get_ydata()[event.ind]

        elif isinstance(event.artist, LineCollection):
            data_period = event.mouseevent.xdata
            data_value = event.mouseevent.ydata

        else:
            print(
                "Picked something other than a Line2D or LineCollection -- SKIPPING"
            )
            print(type(event.artist))
            return

        # modify Z
        if event.mouseevent.button == 3:
            self._edited_mask = True
            self._ax.plot(data_period, data_value, **self.mask_kw)
            f_index = np.where(np.isclose(self.mt_obj.period, data_period))
            if self._ax_index == 0 or self._ax_index == 1:
                d_index = np.where(
                    np.isclose(self.mt_obj.Z.resistivity, data_value)
                )
                try:
                    comp_jj = d_index[1][0]
                    comp_kk = d_index[2][0]
                except IndexError as error:
                    # print("resistivity", error, d_index)
                    return

                # mask phase as well
                if self._ax_index == 0:
                    if comp_jj == 1 and comp_kk == 0:
                        try:
                            self.ax_phase_od.plot(
                                data_period,
                                self.mt_obj.Z.phase[d_index] + 180,
                                **self.mask_kw,
                            )
                        except ValueError as error:
                            pass
                            # print("no yx phase", error)
                    else:
                        try:
                            self.ax_phase_od.plot(
                                data_period,
                                self.mt_obj.Z.phase[d_index],
                                **self.mask_kw,
                            )
                        except ValueError as error:
                            # print("no phase", error)
                            pass

                elif self._ax_index == 1:
                    try:
                        self.ax_phase_d.plot(
                            data_period,
                            self.mt_obj.Z.phase[d_index],
                            **self.mask_kw,
                        )
                    except ValueError as error:
                        # print("no diagonal phase", error)
                        pass

                self.mt_obj._transfer_function.transfer_function.loc[
                    {
                        "output": self._z_output_dict[comp_jj],
                        "input": self._input_dict[comp_kk],
                    }
                ][f_index] = (
                    np.nan + 1j * np.nan
                )
                self.mt_obj._transfer_function.transfer_function_error.loc[
                    {
                        "output": self._z_output_dict[comp_jj],
                        "input": self._input_dict[comp_kk],
                    }
                ][f_index] = np.nan

            # mask phase points
            elif self._ax_index == 2 or self._ax_index == 3:
                print("picked ", data_period, data_value)
                try:
                    d_index = np.where(
                        np.isclose(self.mt_obj.Z.phase, data_value, rtol=0.005)
                    )
                    print(d_index)
                    for ii in d_index[0]:
                        if d_index == f_index:
                            break
                    comp_jj = d_index[1][ii]
                    comp_kk = d_index[2][ii]
                except IndexError:
                    try:
                        d_index = np.where(
                            np.isclose(
                                self.mt_obj.Z.phase,
                                data_value - 180,
                                rtol=0.005,
                            )
                        )
                        print(d_index)
                        for ii in d_index[0]:
                            if d_index == f_index:
                                break
                        comp_jj = d_index[1][ii]
                        comp_kk = d_index[2][ii]

                    except IndexError as error:
                        print("no phase axis", error)
                        return

                self.mt_obj._transfer_function.transfer_function.loc[
                    {
                        "output": self._z_output_dict[comp_jj],
                        "input": self._input_dict[comp_kk],
                    }
                ][f_index] = (
                    np.nan + 1j * np.nan
                )
                self.mt_obj._transfer_function.transfer_function_error.loc[
                    {
                        "output": self._z_output_dict[comp_jj],
                        "input": self._input_dict[comp_kk],
                    }
                ][f_index] = np.nan

                # mask resistivity as well
                if self._ax_index == 2:
                    try:
                        self.ax_res_od.plot(
                            data_period,
                            self.mt_obj.Z.resistivity[d_index],
                            **self.mask_kw,
                        )
                    except ValueError as error:
                        print("no resistivity xy", error)
                        # print("***Picked Invalid Point***", d_index)
                        pass

                elif self._ax_index == 3:
                    try:
                        self.ax_res_d.plot(
                            data_period,
                            self.mt_obj.Z.resistivity[d_index],
                            **self.mask_kw,
                        )
                    except ValueError as error:
                        print("no resistivity yy", error)
                        pass

            # mask tipper Tx
            elif self._ax_index == 4 or self._ax_index == 5:
                data_value = np.round(data_value, 8)
                d_index = np.where(
                    np.isclose(self.mt_obj.Tipper.amplitude, data_value)
                )
                try:
                    comp_jj = d_index[1][0]
                    comp_kk = d_index[2][0]
                except IndexError as error:
                    # print("no tipper", error)
                    return

                self.mt_obj._transfer_function.transfer_function.loc[
                    {
                        "output": self._t_output_dict[comp_jj],
                        "input": self._input_dict[comp_kk],
                    }
                ][f_index] = (
                    np.nan + 1j * np.nan
                )
                self.mt_obj._transfer_function.transfer_function_error.loc[
                    {
                        "output": self._t_output_dict[comp_jj],
                        "input": self._input_dict[comp_kk],
                    }
                ][f_index] = np.nan

                # set tipper data to 0
                self.mt_obj.Tipper.tipper[d_index] = 0.0 + 0.0j
                self.mt_obj.Tipper.tipper_error[d_index] = 0.0

            self._ax.figure.canvas.draw()

    def in_axes(self, event):
        """
        check to see which axis the mouse is in
        """

        self._ax = event.inaxes

        # find the component index so that it can be masked
        for ax_index, ax in enumerate(self.ax_list):
            if ax == event.inaxes:
                self._ax_index = ax_index

    def _get_frequency_range(self, period_01, period_02):

        fmin = min([1.0 / period_01, 1.0 / period_02])
        fmax = max([1.0 / period_01, 1.0 / period_02])
        prange = np.where(
            (self.mt_obj.frequency >= fmin) & (self.mt_obj.frequency <= fmax)
        )

        return prange

    def rect_onselect_od(self, eclick, erelease):
        x1 = eclick.xdata
        x2 = erelease.xdata

        f_idx = self._get_frequency_range(x1, x2)

        for ff in f_idx:
            data_period = 1.0 / self.mt_obj.frequency[ff]
            if self.edits_mode == "Both" or self.edits_mode == "X":
                self.ax_res_od.plot(
                    data_period,
                    self.mt_obj.Z.resistivity[ff, 0, 1],
                    **self.mask_kw,
                )
                self.ax_phase_od.plot(
                    data_period, self.mt_obj.Z.phase[ff, 0, 1], **self.mask_kw
                )
                self.mt_obj.Z.z[ff, 0, 1] = 0.0 + 0.0 * 1j
                self.mt_obj.Z.z_error[ff, 0, 1] = 0.0

            if self.edits_mode == "Both" or self.edits_mode == "Y":
                self.ax_res_od.plot(
                    data_period,
                    self.mt_obj.Z.resistivity[ff, 1, 0],
                    **self.mask_kw,
                )

                self.ax_phase_od.plot(
                    data_period,
                    self.mt_obj.Z.phase[ff, 1, 0] + 180,
                    **self.mask_kw,
                )

                self.mt_obj.Z.z[ff, 1, 0] = 0.0 + 0.0 * 1j
                self.mt_obj.Z.z_error[ff, 1, 0] = 0.0

        self.ax_res_od.figure.canvas.draw()
        self.ax_phase_od.figure.canvas.draw()

    def rect_onselect_d(self, eclick, erelease):
        x1 = eclick.xdata
        x2 = erelease.xdata

        f_idx = self._get_frequency_range(x1, x2)

        for ff in f_idx:
            data_period = 1.0 / self.mt_obj.frequency[ff]
            if self.edits_mode == "Both" or self.edits_mode == "X":
                self.ax_res_d.plot(
                    data_period,
                    self.mt_obj.Z.resistivity[ff, 0, 0],
                    **self.mask_kw,
                )
                self.ax_phase_d.plot(
                    data_period, self.mt_obj.Z.phase[ff, 0, 0], **self.mask_kw
                )
                self.mt_obj.Z.z[ff, 0, 0] = 0.0 + 0.0 * 1j
                self.mt_obj.Z.z_error[ff, 0, 0] = 0.0

            if self.edits_mode == "Both" or self.edits_mode == "Y":
                self.ax_res_d.plot(
                    data_period,
                    self.mt_obj.Z.resistivity[ff, 1, 1],
                    **self.mask_kw,
                )

                self.ax_phase_d.plot(
                    data_period, self.mt_obj.Z.phase[ff, 1, 1], **self.mask_kw
                )

                self.mt_obj.Z.z[ff, 1, 1] = 0.0 + 0.0 * 1j
                self.mt_obj.Z.z_error[ff, 1, 1] = 0.0

        self.ax_res_od.figure.canvas.draw()
        self.ax_phase_od.figure.canvas.draw()

    def rect_onselect_tr(self, eclick, erelease):
        x1 = eclick.xdata
        x2 = erelease.xdata

        try:
            f_idx = self._get_frequency_range(x1, x2)
        except ZeroDivisionError:
            print("***Picked Invalid Points***")
            return

        for ff in f_idx:
            data_period = 1.0 / self.mt_obj.frequency[ff]
            self.ax_tip_x.plot(
                data_period,
                self.mt_obj.Tipper.amplitude[ff, 0, 0],
                **self.mask_kw,
            )

            self.mt_obj.Tipper.tipper[ff, 0, 0] = 0.0 + 0.0 * 1j
            self.mt_obj.Tipper.tipper_error[ff, 0, 0] = 0.0

        self.mt_obj.Tipper.compute_amp_phase()

        self.ax_tip_x.figure.canvas.draw()

    def rect_onselect_ti(self, eclick, erelease):
        x1 = eclick.xdata
        x2 = erelease.xdata

        f_idx = self._get_frequency_range(x1, x2)

        for ff in f_idx:
            data_period = 1.0 / self.mt_obj.frequency[ff]
            self.ax_tip_y.plot(
                data_period,
                self.mt_obj.Tipper.amplitude[ff, 0, 1],
                **self.mask_kw,
            )

            self.mt_obj.Tipper.tipper[ff, 0, 1] = 0.0 + 0.0 * 1j
            self.mt_obj.Tipper.tipper_error[ff, 0, 1] = 0.0

        self.mt_obj.Tipper.compute_amp_phase()

        self.ax_tip_y.figure.canvas.draw()


# ==============================================================================
#  Plot setting
# ==============================================================================
class PlotSettings(QtWidgets.QWidget):
    settings_updated = QtCore.pyqtSignal()

    def __init__(self, parent, **kwargs):
        super(PlotSettings, self).__init__(parent)

        self.fs = kwargs.pop("fs", 10)
        self.lw = kwargs.pop("lw", 1.0)
        self.ms = kwargs.pop("ms", 4)

        self.e_capthick = kwargs.pop("e_capthick", 1)
        self.e_capsize = kwargs.pop("e_capsize", 4)

        self.cted = kwargs.pop("cted", (0, 0, 0.65))
        self.ctmd = kwargs.pop("ctmd", (0.65, 0, 0))
        self.cteo = kwargs.pop("cted", (0.5, 0.5, 0.5))
        self.ctmo = kwargs.pop("ctmd", (0.75, 0.75, 0.75))

        self.mted = kwargs.pop("mted", "s")
        self.mtmd = kwargs.pop("mtmd", "o")

        self.res_limits_od = kwargs.pop("res_limits_od", None)
        self.res_limits_d = kwargs.pop("res_limits_d", None)

        self._res_limits_od_min = None
        self._res_limits_od_max = None
        self._res_limits_d_min = None
        self._res_limits_d_max = None

        self.phase_limits_od = kwargs.pop("phase_limits_od", None)
        self.phase_limits_d = kwargs.pop("phase_limits_d", None)

        self._phase_limits_od_min = None
        self._phase_limits_od_max = None
        self._phase_limits_d_min = None
        self._phase_limits_d_max = None

        self.tipper_x_limits = kwargs.pop("tipper_x_limits", None)
        self.tipper_y_limits = kwargs.pop("tipper_y_limits", None)

        self._tip_x_limits_min = -1
        self._tip_x_limits_max = 1
        self._tip_y_limits_min = -1
        self._tip_y_limits_max = 1

        self.subplot_wspace = kwargs.pop("subplot_wspace", 0.15)
        self.subplot_hspace = kwargs.pop("subplot_hspace", 0.00)
        self.subplot_right = kwargs.pop("subplot_right", 0.97)
        self.subplot_left = kwargs.pop("subplot_left", 0.08)
        self.subplot_top = kwargs.pop("subplot_top", 0.93)
        self.subplot_bottom = kwargs.pop("subplot_bottom", 0.08)

        self.tipper_x_color = kwargs.pop("tipper_x_color", (0.4, 0, 0.2))
        self.tipper_y_color = kwargs.pop("tipper_y_color", (0, 0.9, 0.9))

        self.plot_original_data = kwargs.pop("plot_original_data", True)

        self.mask_marker = kwargs.pop("mask_marker", "x")
        self.mask_ms = kwargs.pop("mask_ms", 10)
        self.mask_mew = kwargs.pop("mask_mew", 3)
        self.mask_color = kwargs.pop("mask_color", "k")

        # self.setup_ui()

    def setup_ui(self):
        """
        setup the user interface
        """

        self.fs_label = QtWidgets.QLabel("Font Size")
        self.fs_edit = QtWidgets.QLineEdit("{0:.2f}".format(self.fs))
        self.fs_edit.editingFinished.connect(self.set_fs)

        self.lw_label = QtWidgets.QLabel("Line Width")
        self.lw_edit = QtWidgets.QLineEdit("{0:.2f}".format(self.lw))
        self.lw_edit.editingFinished.connect(self.set_lw)

        self.ms_label = QtWidgets.QLabel("Marker Size")
        self.ms_edit = QtWidgets.QLineEdit("{0:.2f}".format(self.ms))
        self.ms_edit.editingFinished.connect(self.set_ms)

        self.mted_label = QtWidgets.QLabel("Marker x components")
        self.mted_combo = QtWidgets.QComboBox()
        self.mted_combo.addItem(self.mted)
        self.mted_combo.addItem(".")
        self.mted_combo.addItem(",")
        self.mted_combo.addItem("o")
        self.mted_combo.addItem("v")
        self.mted_combo.addItem("^")
        self.mted_combo.addItem("<")
        self.mted_combo.addItem(">")
        self.mted_combo.addItem("s")
        self.mted_combo.addItem("p")
        self.mted_combo.addItem("*")
        self.mted_combo.addItem("h")
        self.mted_combo.addItem("H")
        self.mted_combo.addItem("+")
        self.mted_combo.addItem("x")
        self.mted_combo.addItem("D")
        self.mted_combo.addItem("d")
        self.mted_combo.addItem("|")
        self.mted_combo.addItem("_")
        self.mted_combo.activated[str].connect(self.set_mted)

        self.mtmd_label = QtWidgets.QLabel("Marker y components")
        self.mtmd_combo = QtWidgets.QComboBox()
        self.mtmd_combo.addItem(self.mtmd)
        self.mtmd_combo.addItem(".")
        self.mtmd_combo.addItem(",")
        self.mtmd_combo.addItem("o")
        self.mtmd_combo.addItem("v")
        self.mtmd_combo.addItem("^")
        self.mtmd_combo.addItem("<")
        self.mtmd_combo.addItem(">")
        self.mtmd_combo.addItem("s")
        self.mtmd_combo.addItem("p")
        self.mtmd_combo.addItem("*")
        self.mtmd_combo.addItem("h")
        self.mtmd_combo.addItem("H")
        self.mtmd_combo.addItem("+")
        self.mtmd_combo.addItem("x")
        self.mtmd_combo.addItem("D")
        self.mtmd_combo.addItem("d")
        self.mtmd_combo.addItem("|")
        self.mtmd_combo.addItem("_")
        self.mtmd_combo.activated[str].connect(self.set_mtmd)

        self.e_capsize_label = QtWidgets.QLabel("Error bar cap size")
        self.e_capsize_edit = QtWidgets.QLineEdit(
            "{0:.2f}".format(self.e_capsize)
        )
        self.e_capsize_edit.editingFinished.connect(self.set_e_capsize)

        self.e_capthick_label = QtWidgets.QLabel("Error bar cap thickness")
        self.e_capthick_edit = QtWidgets.QLineEdit(
            "{0:.2f}".format(self.e_capthick)
        )
        self.e_capthick_edit.editingFinished.connect(self.set_e_capthick)

        self.cted_button = QtWidgets.QPushButton("Set Z_xi Color")
        self.cted_button.pressed.connect(self.set_cted)

        self.ctmd_button = QtWidgets.QPushButton("Set Z_yi Color")
        self.ctmd_button.pressed.connect(self.set_ctmd)

        self.ctx_button = QtWidgets.QPushButton("Set T_x Color")
        self.ctx_button.pressed.connect(self.set_ctx)

        self.cty_button = QtWidgets.QPushButton("Set T_y Color")
        self.cty_button.pressed.connect(self.set_cty)

        self.cteo_button = QtWidgets.QPushButton("Set Original Data_xi Color")
        self.cteo_button.pressed.connect(self.set_cteo)

        self.ctmo_button = QtWidgets.QPushButton("Set Original Data_yi Color")
        self.ctmo_button.pressed.connect(self.set_ctmo)

        self.resod_limits_label = QtWidgets.QLabel(
            "Off Diagonal Res. Limits (min, max)"
        )

        self.resod_limits_min_edit = QtWidgets.QLineEdit()
        self.resod_limits_min_edit.editingFinished.connect(self.set_resod_min)

        self.resod_limits_max_edit = QtWidgets.QLineEdit()
        self.resod_limits_max_edit.editingFinished.connect(self.set_resod_max)

        self.resd_limits_label = QtWidgets.QLabel(
            "Diagonal Res. Limits (min, max)"
        )

        self.resd_limits_min_edit = QtWidgets.QLineEdit()
        self.resd_limits_min_edit.editingFinished.connect(self.set_resd_min)

        self.resd_limits_max_edit = QtWidgets.QLineEdit()
        self.resd_limits_max_edit.editingFinished.connect(self.set_resd_max)

        self.phaseod_limits_label = QtWidgets.QLabel(
            "Off Diagonal phase. Limits (min, max)"
        )

        self.phaseod_limits_min_edit = QtWidgets.QLineEdit()
        self.phaseod_limits_min_edit.editingFinished.connect(
            self.set_phaseod_min
        )

        self.phaseod_limits_max_edit = QtWidgets.QLineEdit()
        self.phaseod_limits_max_edit.editingFinished.connect(
            self.set_phaseod_max
        )

        self.phased_limits_label = QtWidgets.QLabel(
            "Diagonal phase. Limits (min, max)"
        )

        self.phased_limits_min_edit = QtWidgets.QLineEdit()
        self.phased_limits_min_edit.editingFinished.connect(
            self.set_phased_min
        )

        self.phased_limits_max_edit = QtWidgets.QLineEdit()
        self.phased_limits_max_edit.editingFinished.connect(
            self.set_phased_max
        )

        self.tip_x_limits_label = QtWidgets.QLabel("T_x limits (min, max)")

        self.tip_x_limits_min_edit = QtWidgets.QLineEdit()
        self.tip_x_limits_min_edit.editingFinished.connect(self.set_tip_x_min)

        self.tip_x_limits_max_edit = QtWidgets.QLineEdit()
        self.tip_x_limits_max_edit.editingFinished.connect(self.set_tip_x_max)

        self.tip_y_limits_label = QtWidgets.QLabel("T_y limits (min, max)")

        self.tip_y_limits_min_edit = QtWidgets.QLineEdit()
        self.tip_y_limits_min_edit.editingFinished.connect(self.set_tip_y_min)

        self.tip_y_limits_max_edit = QtWidgets.QLineEdit()
        self.tip_y_limits_max_edit.editingFinished.connect(self.set_tip_y_max)

        self.update_button = QtWidgets.QPushButton("Update Settings")
        self.update_button.pressed.connect(self.update_settings)

        ## --> layout
        grid = QtWidgets.QGridLayout()

        grid.addWidget(self.fs_label, 0, 0)
        grid.addWidget(self.fs_edit, 0, 1)
        grid.addWidget(self.lw_label, 0, 2)
        grid.addWidget(self.lw_edit, 0, 3)
        grid.addWidget(self.ms_label, 1, 0)
        grid.addWidget(self.ms_edit, 1, 1)
        grid.addWidget(self.mted_label, 1, 2)
        grid.addWidget(self.mted_combo, 1, 3)
        grid.addWidget(self.mtmd_label, 1, 4)
        grid.addWidget(self.mtmd_combo, 1, 5)
        grid.addWidget(self.cted_button, 2, 0, 1, 3)
        grid.addWidget(self.ctmd_button, 2, 3, 1, 3)
        grid.addWidget(self.cteo_button, 3, 0, 1, 3)
        grid.addWidget(self.ctmo_button, 3, 3, 1, 3)
        grid.addWidget(self.ctx_button, 4, 0, 1, 3)
        grid.addWidget(self.cty_button, 4, 3, 1, 3)
        grid.addWidget(self.resod_limits_label, 5, 0)
        grid.addWidget(self.resod_limits_min_edit, 5, 1)
        grid.addWidget(self.resod_limits_max_edit, 5, 2)
        grid.addWidget(self.resd_limits_label, 5, 3)
        grid.addWidget(self.resd_limits_min_edit, 5, 4)
        grid.addWidget(self.resd_limits_max_edit, 5, 5)
        grid.addWidget(self.phaseod_limits_label, 6, 0)
        grid.addWidget(self.phaseod_limits_min_edit, 6, 1)
        grid.addWidget(self.phaseod_limits_max_edit, 6, 2)
        grid.addWidget(self.phased_limits_label, 6, 3)
        grid.addWidget(self.phased_limits_min_edit, 6, 4)
        grid.addWidget(self.phased_limits_max_edit, 6, 5)
        grid.addWidget(self.tip_x_limits_label, 7, 0)
        grid.addWidget(self.tip_x_limits_min_edit, 7, 1)
        grid.addWidget(self.tip_x_limits_max_edit, 7, 2)
        grid.addWidget(self.tip_y_limits_label, 7, 3)
        grid.addWidget(self.tip_y_limits_min_edit, 7, 4)
        grid.addWidget(self.tip_y_limits_max_edit, 7, 5)
        grid.addWidget(self.update_button, 10, 0, 1, 6)

        self.setLayout(grid)
        self.setWindowTitle("Plot Settings")
        self.show()

    def convert_color_to_qt(self, color):
        """
        convert decimal tuple to QColor object
        """
        r = int(color[0] * 255)
        g = int(color[1] * 255)
        b = int(color[2] * 255)

        return QtGui.QColor(r, g, b)

    def set_fs(self):
        self.fs = float(str(self.fs_edit.text()))
        self.fs_edit.setText("{0:.2f}".format(self.fs))

    def set_lw(self):
        self.lw = float(str(self.lw_edit.text()))
        self.lw_edit.setText("{0:.2f}".format(self.lw))

    def set_ms(self):
        self.ms = float(str(self.ms_edit.text()))
        self.ms_edit.setText("{0:.2f}".format(self.ms))

    def set_e_capsize(self):
        self.e_capsize = float(str(self.e_capsize_edit.text()))
        self.e_capsize_edit.setText("{0:.2f}".format(self.e_capsize))

    def set_e_capthick(self):
        self.e_capthick = float(str(self.e_capthick_edit.text()))
        self.e_capthick_edit.setText("{0:.2f}".format(self.e_capthick))

    def set_mted(self, text):
        self.mted = text

    def set_mtmd(self, text):
        self.mtmd = text

    def set_resod_min(self):
        try:
            self._res_limits_od_min = float(
                str(self.resod_limits_min_edit.text())
            )
        except ValueError:
            self._res_limits_od_min = None

    def set_resod_max(self):
        try:
            self._res_limits_od_max = float(
                str(self.resod_limits_max_edit.text())
            )
        except ValueError:
            self._res_limits_od_max = None

    def set_resd_min(self):
        try:
            self._res_limits_d_min = float(
                str(self.resd_limits_min_edit.text())
            )
        except ValueError:
            self._res_limits_d_min = None

    def set_resd_max(self):
        try:
            self._res_limits_d_max = float(
                str(self.resd_limits_max_edit.text())
            )
        except ValueError:
            self._res_limits_d_max = None

    def set_phaseod_min(self):
        try:
            self._phase_limits_od_min = float(
                str(self.phaseod_limits_min_edit.text())
            )
        except ValueError:
            self._phase_limits_od_min = None

    def set_phaseod_max(self):
        try:
            self._phase_limits_od_max = float(
                str(self.phaseod_limits_max_edit.text())
            )
        except ValueError:
            self._phase_limits_od_max = None

    def set_phased_min(self):
        try:
            self._phase_limits_d_min = float(
                str(self.phased_limits_min_edit.text())
            )
        except ValueError:
            self._phase_limits_d_min = None

    def set_phased_max(self):
        try:
            self._phase_limits_d_max = float(
                str(self.phased_limits_max_edit.text())
            )
        except ValueError:
            self._phase_limits_d_max = None

    def set_tip_x_min(self):
        try:
            self._tip_x_limits_min = float(
                str(self.tip_x_limits_min_edit.text())
            )
        except ValueError:
            self._tip_x_limits_min = None

    def set_tip_x_max(self):
        try:
            self._tip_x_limits_max = float(
                str(self.tip_x_limits_max_edit.text())
            )
        except ValueError:
            self._tip_x_limits_max = None

    def set_tip_y_min(self):
        try:
            self._tip_y_limits_min = float(
                str(self.tip_y_limits_min_edit.text())
            )
        except ValueError:
            self._tip_y_limits_min = None

    def set_tip_y_max(self):
        try:
            self._tip_y_limits_max = float(
                str(self.tip_y_limits_max_edit.text())
            )
        except ValueError:
            self._tip_y_limits_max = None

    def set_cted(self):
        initial_color = self.convert_color_to_qt(self.cted)
        new_color = QtWidgets.QColorDialog.getColor(initial_color)

        r, g, b, a = new_color.getRgbF()

        self.cted = (r, g, b)

    def set_ctmd(self):
        initial_color = self.convert_color_to_qt(self.ctmd)
        new_color = QtWidgets.QColorDialog.getColor(initial_color)

        r, g, b, a = new_color.getRgbF()

        self.ctmd = (r, g, b)

    def set_ctx(self):
        initial_color = self.convert_color_to_qt(self.tipper_x_color)
        new_color = QtWidgets.QColorDialog.getColor(initial_color)

        r, g, b, a = new_color.getRgbF()

        self.tipper_x_color = (r, g, b)

    def set_cty(self):
        initial_color = self.convert_color_to_qt(self.tipper_y_color)
        new_color = QtWidgets.QColorDialog.getColor(initial_color)

        r, g, b, a = new_color.getRgbF()

        self.tipper_y_color = (r, g, b)

    def set_cteo(self):
        initial_color = self.convert_color_to_qt(self.cteo)
        new_color = QtWidgets.QColorDialog.getColor(initial_color)

        r, g, b, a = new_color.getRgbF()

        self.cteo = (r, g, b)

    def set_ctmo(self):
        initial_color = self.convert_color_to_qt(self.ctmo)
        new_color = QtWidgets.QColorDialog.getColor(initial_color)

        r, g, b, a = new_color.getRgbF()

        self.ctmo = (r, g, b)

    def update_settings(self):
        if self._res_limits_od_min != None and self._res_limits_od_max != None:
            self.res_limits_od = (
                self._res_limits_od_min,
                self._res_limits_od_max,
            )
        else:
            self.res_limits_od = None

        if self._res_limits_d_min != None and self._res_limits_d_max != None:
            self.res_limits_d = (
                self._res_limits_d_min,
                self._res_limits_d_max,
            )
        else:
            self.res_limits_d = None

        if (
            self._phase_limits_od_min != None
            and self._phase_limits_od_max != None
        ):
            self.phase_limits_od = (
                self._phase_limits_od_min,
                self._phase_limits_od_max,
            )
        else:
            self.phase_limits_od = None

        if (
            self._phase_limits_d_min != None
            and self._phase_limits_d_max != None
        ):
            self.phase_limits_d = (
                self._phase_limits_d_min,
                self._phase_limits_d_max,
            )
        else:
            self.phase_limits_d = None

        if self._tip_x_limits_min != None and self._tip_x_limits_max != None:
            self.tipper_x_limits = (
                self._tip_x_limits_min,
                self._tip_x_limits_max,
            )
        else:
            self.tipper_x_limits = None

        if self._tip_y_limits_min != None and self._tip_y_limits_max != None:
            self.tipper_y_limits = (
                self._tip_y_limits_min,
                self._tip_y_limits_max,
            )
        else:
            self.tipper_y_limits = None

        self.settings_updated.emit()


# ==============================================================================
# mt text editor
# ==============================================================================
class MTTextEditor(QtWidgets.QWidget):
    """
    class to edit the text of an .mt file
    """

    metadata_updated = QtCore.pyqtSignal()

    def __init__(self, mt_object):
        super(MTTextEditor, self).__init__()

        self.mt_obj = mt_object

        self.setup_ui()

    def setup_ui(self):

        self.setWindowTitle("MT Text Editor")

        # header label font
        header_font = QtGui.QFont()
        header_font.setBold = True
        header_font.setPointSize(16)

        ##--> header information
        self.header_label = QtWidgets.QLabel("Header Information")
        self.header_label.setFont(header_font)

        self.header_acqby_label = QtWidgets.QLabel("Acquired By")
        self.header_acqby_edit = QtWidgets.QLineEdit(self.mt_obj.Header.acqby)
        self.header_acqby_edit.editingFinished.connect(self.header_set_acqby)

        self.header_acqdate_label = QtWidgets.QLabel(
            "Acquired Date (YYYY-MM-DD)"
        )
        self.header_acqdate_edit = QtWidgets.QLineEdit(
            self.mt_obj.Header.acqdate
        )
        self.header_acqdate_edit.editingFinished.connect(
            self.header_set_acqdate
        )

        self.header_dataid_label = QtWidgets.QLabel("Station Name")
        self.header_dataid_edit = QtWidgets.QLineEdit(
            self.mt_obj.Header.dataid
        )
        self.header_dataid_edit.editingFinished.connect(self.header_set_dataid)

        self.header_elev_label = QtWidgets.QLabel("Elevation (m)")
        self.header_elev_edit = QtWidgets.QLineEdit()
        if self.mt_obj.elev is None:
            self.header_elev_edit.setText("0.0")
        else:
            self.header_elev_edit.setText("{0:.1f}".format(self.mt_obj.elev))

        self.header_elev_edit.editingFinished.connect(self.header_set_elev)

        self.header_empty_label = QtWidgets.QLabel("Empty Value")
        self.header_empty_edit = QtWidgets.QLineEdit(
            "{0}".format(self.mt_obj.Header.empty)
        )
        self.header_empty_edit.editingFinished.connect(self.header_set_empty)

        self.header_fileby_label = QtWidgets.QLabel("File By")
        self.header_fileby_edit = QtWidgets.QLineEdit(
            self.mt_obj.Header.fileby
        )
        self.header_fileby_edit.editingFinished.connect(self.header_set_fileby)

        self.header_filedate_label = QtWidgets.QLabel("File Date (YYY-MM-DD)")
        self.header_filedate_edit = QtWidgets.QLineEdit(
            self.mt_obj.Header.filedate
        )
        self.header_filedate_edit.editingFinished.connect(
            self.header_set_filedate
        )

        self.header_lat_label = QtWidgets.QLabel("Latitude (decimal degrees)")
        self.header_lat_edit = QtWidgets.QLineEdit()
        if self.mt_obj.lat is None:
            self.header_lat_edit.setText("0.000000")
        else:
            self.header_lat_edit.setText("{0:.5f}".format(self.mt_obj.lat))
        self.header_lat_edit.editingFinished.connect(self.header_set_lat)

        self.header_lon_label = QtWidgets.QLabel("Longitude (decimal degrees)")
        self.header_lon_edit = QtWidgets.QLineEdit()
        if self.mt_obj.lon is None:
            self.header_lon_edit.setText("0.000000")
        else:
            self.header_lon_edit.setText("{0:.5f}".format(self.mt_obj.lon))
        self.header_lon_edit.editingFinished.connect(self.header_set_lon)

        self.header_loc_label = QtWidgets.QLabel("Location")
        self.header_loc_edit = QtWidgets.QLineEdit(self.mt_obj.Header.loc)
        self.header_loc_edit.editingFinished.connect(self.header_set_loc)

        self.header_progdate_label = QtWidgets.QLabel("Program Date")
        self.header_progdate_edit = QtWidgets.QLineEdit(
            self.mt_obj.Header.progdate
        )
        self.header_progdate_edit.editingFinished.connect(
            self.header_set_progdate
        )

        self.header_progvers_label = QtWidgets.QLabel("Program Version")
        self.header_progvers_edit = QtWidgets.QLineEdit(
            self.mt_obj.Header.progvers
        )
        self.header_progvers_edit.editingFinished.connect(
            self.header_set_progvers
        )

        ##--> Info
        self.info_label = QtWidgets.QLabel("Information Section")
        self.info_label.setFont(header_font)

        self.info_edit = QtWidgets.QTextEdit()
        self.info_edit.setMinimumWidth(500)
        try:
            info_str = "".join(self.mt_obj.Info.write_info())
        except TypeError:
            info_str = ""
        self.info_edit.setText(info_str)
        self.info_edit.textChanged.connect(self.info_set_text)

        ##--> define measurement
        self.define_label = QtWidgets.QLabel("Define Measurement")
        self.define_label.setFont(header_font)

        self.define_maxchan_label = QtWidgets.QLabel("Maximum Channels")
        self.define_maxchan_edit = QtWidgets.QLineEdit(
            "{0}".format(self.mt_obj.Define_measurement.maxchan)
        )
        self.define_maxchan_edit.editingFinished.connect(
            self.define_set_maxchan
        )

        self.define_maxrun_label = QtWidgets.QLabel("Maximum Runs")
        self.define_maxrun_edit = QtWidgets.QLineEdit(
            "{0}".format(self.mt_obj.Define_measurement.maxrun)
        )
        self.define_maxrun_edit.editingFinished.connect(self.define_set_maxrun)

        self.define_maxmeas_label = QtWidgets.QLabel("Maximum Measurements")
        self.define_maxmeas_edit = QtWidgets.QLineEdit(
            "{0}".format(self.mt_obj.Define_measurement.maxmeas)
        )
        self.define_maxmeas_edit.editingFinished.connect(
            self.define_set_maxmeas
        )

        self.define_refelev_label = QtWidgets.QLabel("Reference Elevation (m)")
        self.define_refelev_edit = QtWidgets.QLineEdit()
        if self.mt_obj.Define_measurement.refelev is None:
            self.define_refelev_edit.setText("0.0")
        else:
            self.define_refelev_edit.setText(
                "{0:.5f}".format(self.mt_obj.Define_measurement.refelev)
            )
        self.define_refelev_edit.editingFinished.connect(
            self.define_set_refelev
        )

        self.define_reflat_label = QtWidgets.QLabel(
            "Reference Latitude (dec. deg)"
        )
        self.define_reflat_edit = QtWidgets.QLineEdit()
        if self.mt_obj.Define_measurement.refelev is None:
            self.define_reflat_edit.setText("0.0000000")
        else:
            self.define_reflat_edit.setText(
                "{0:.5f}".format(self.mt_obj.Define_measurement.reflat)
            )
        self.define_reflat_edit.editingFinished.connect(self.define_set_reflat)

        self.define_reflon_label = QtWidgets.QLabel(
            "Reference Longitude (dec. deg)"
        )
        self.define_reflon_edit = QtWidgets.QLineEdit()
        if self.mt_obj.Define_measurement.reflon is None:
            self.define_reflon_edit.setText("0.000000")
        else:
            self.define_reflon_edit.setText(
                "{0:.5f}".format(self.mt_obj.Define_measurement.reflon)
            )
        self.define_reflon_edit.editingFinished.connect(self.define_set_reflon)

        # self.define_refloc_label = QtWidgets.QLabel('Reference Location')
        # self.define_refloc_edit = QtWidgets.QLineEdit('{0}'.format(self.mt_obj.Define_measurement.refloc))
        # self.define_refloc_edit.editingFinished.connect(self.define_set_refloc)

        self.define_reftype_label = QtWidgets.QLabel("Reference Type")
        self.define_reftype_edit = QtWidgets.QLineEdit(
            "{0}".format(self.mt_obj.Define_measurement.reftype)
        )
        self.define_reftype_edit.editingFinished.connect(
            self.define_set_reftype
        )

        self.define_units_label = QtWidgets.QLabel("Distance Units")
        self.define_units_edit = QtWidgets.QLineEdit(
            "{0}".format(self.mt_obj.Define_measurement.units)
        )
        self.define_units_edit.editingFinished.connect(self.define_set_units)

        self.meas_help = QtWidgets.QLabel()
        self.meas_help.setText(
            "Assume x is northing (m), y is easting (m), North = 0 deg, East = 90 deg"
        )
        h_ch_list = ["HX", "HY", "HZ", "RHX", "RHY"]
        self.meas_h01_label = QtWidgets.QLabel("HMEAS")
        self.meas_h01_id_label = QtWidgets.QLabel("ID")
        self.meas_h01_id_edit = QtWidgets.QLineEdit()
        self.meas_h01_ct_label = QtWidgets.QLabel("CHTYPE")
        self.meas_h01_ct_combo = QtWidgets.QComboBox()
        self.meas_h01_ct_combo.addItems(h_ch_list)
        self.meas_h01_x_label = QtWidgets.QLabel("X (m)")
        self.meas_h01_x_edit = QtWidgets.QLineEdit()
        self.meas_h01_y_label = QtWidgets.QLabel("Y (m)")
        self.meas_h01_y_edit = QtWidgets.QLineEdit()
        self.meas_h01_azm_label = QtWidgets.QLabel("Azimtuh (deg)")
        self.meas_h01_azm_edit = QtWidgets.QLineEdit()
        self.meas_h01_acqchn_label = QtWidgets.QLabel("Acq. Channel")
        self.meas_h01_acqchn_combo = QtWidgets.QComboBox()
        self.meas_h01_acqchn_combo.addItems(h_ch_list)

        self.meas_h02_label = QtWidgets.QLabel("HMEAS")
        self.meas_h02_id_label = QtWidgets.QLabel("ID")
        self.meas_h02_id_edit = QtWidgets.QLineEdit()
        self.meas_h02_ct_label = QtWidgets.QLabel("CHTYPE")
        self.meas_h02_ct_combo = QtWidgets.QComboBox()
        self.meas_h02_ct_combo.addItems(h_ch_list)
        self.meas_h02_x_label = QtWidgets.QLabel("X (m)")
        self.meas_h02_x_edit = QtWidgets.QLineEdit()
        self.meas_h02_y_label = QtWidgets.QLabel("Y (m)")
        self.meas_h02_y_edit = QtWidgets.QLineEdit()
        self.meas_h02_azm_label = QtWidgets.QLabel("Azimtuh (deg)")
        self.meas_h02_azm_edit = QtWidgets.QLineEdit()
        self.meas_h02_acqchn_label = QtWidgets.QLabel("Acq. Channel")
        self.meas_h02_acqchn_combo = QtWidgets.QComboBox()
        self.meas_h02_acqchn_combo.addItems(h_ch_list)

        self.meas_h03_label = QtWidgets.QLabel("HMEAS")
        self.meas_h03_id_label = QtWidgets.QLabel("ID")
        self.meas_h03_id_edit = QtWidgets.QLineEdit()
        self.meas_h03_ct_label = QtWidgets.QLabel("CHTYPE")
        self.meas_h03_ct_combo = QtWidgets.QComboBox()
        self.meas_h03_ct_combo.addItems(h_ch_list)
        self.meas_h03_x_label = QtWidgets.QLabel("X (m)")
        self.meas_h03_x_edit = QtWidgets.QLineEdit()
        self.meas_h03_y_label = QtWidgets.QLabel("Y (m)")
        self.meas_h03_y_edit = QtWidgets.QLineEdit()
        self.meas_h03_azm_label = QtWidgets.QLabel("Azimtuh (deg)")
        self.meas_h03_azm_edit = QtWidgets.QLineEdit()
        self.meas_h03_acqchn_label = QtWidgets.QLabel("Acq. Channel")
        self.meas_h03_acqchn_combo = QtWidgets.QComboBox()
        self.meas_h03_acqchn_combo.addItems(h_ch_list)

        self.meas_hr1_label = QtWidgets.QLabel("HMEAS")
        self.meas_hr1_id_label = QtWidgets.QLabel("ID")
        self.meas_hr1_id_edit = QtWidgets.QLineEdit()
        self.meas_hr1_ct_label = QtWidgets.QLabel("CHTYPE")
        self.meas_hr1_ct_combo = QtWidgets.QComboBox()
        self.meas_hr1_ct_combo.addItems(h_ch_list)
        self.meas_hr1_x_label = QtWidgets.QLabel("X (m)")
        self.meas_hr1_x_edit = QtWidgets.QLineEdit()
        self.meas_hr1_y_label = QtWidgets.QLabel("Y (m)")
        self.meas_hr1_y_edit = QtWidgets.QLineEdit()
        self.meas_hr1_azm_label = QtWidgets.QLabel("Azimtuh (deg)")
        self.meas_hr1_azm_edit = QtWidgets.QLineEdit()
        self.meas_hr1_acqchn_label = QtWidgets.QLabel("Acq. Channel")
        self.meas_hr1_acqchn_combo = QtWidgets.QComboBox()
        self.meas_hr1_acqchn_combo.addItems(h_ch_list)

        self.meas_hr2_label = QtWidgets.QLabel("HMEAS")
        self.meas_hr2_id_label = QtWidgets.QLabel("ID")
        self.meas_hr2_id_edit = QtWidgets.QLineEdit()
        self.meas_hr2_ct_label = QtWidgets.QLabel("CHTYPE")
        self.meas_hr2_ct_combo = QtWidgets.QComboBox()
        self.meas_hr2_ct_combo.addItems(h_ch_list)
        self.meas_hr2_x_label = QtWidgets.QLabel("X (m)")
        self.meas_hr2_x_edit = QtWidgets.QLineEdit()
        self.meas_hr2_y_label = QtWidgets.QLabel("Y (m)")
        self.meas_hr2_y_edit = QtWidgets.QLineEdit()
        self.meas_hr2_azm_label = QtWidgets.QLabel("Azimtuh (deg)")
        self.meas_hr2_azm_edit = QtWidgets.QLineEdit()
        self.meas_hr2_acqchn_label = QtWidgets.QLabel("Acq. Channel")
        self.meas_hr2_acqchn_combo = QtWidgets.QComboBox()
        self.meas_hr2_acqchn_combo.addItems(h_ch_list)

        e_ch_list = ["EX", "EY", "EZ"]
        self.meas_e01_label = QtWidgets.QLabel("EMEAS")
        self.meas_e01_id_label = QtWidgets.QLabel("ID")
        self.meas_e01_id_edit = QtWidgets.QLineEdit()
        self.meas_e01_ct_label = QtWidgets.QLabel("CHTYPE")
        self.meas_e01_ct_combo = QtWidgets.QComboBox()
        self.meas_e01_ct_combo.addItems(e_ch_list)
        self.meas_e01_x_label = QtWidgets.QLabel("X (m)")
        self.meas_e01_x_edit = QtWidgets.QLineEdit()
        self.meas_e01_y_label = QtWidgets.QLabel("Y (m)")
        self.meas_e01_y_edit = QtWidgets.QLineEdit()
        self.meas_e01_x2_label = QtWidgets.QLabel("X2 (m)")
        self.meas_e01_x2_edit = QtWidgets.QLineEdit()
        self.meas_e01_y2_label = QtWidgets.QLabel("Y2 (m)")
        self.meas_e01_y2_edit = QtWidgets.QLineEdit()
        self.meas_e01_acqchn_label = QtWidgets.QLabel("Acq. Channel")
        self.meas_e01_acqchn_combo = QtWidgets.QComboBox()
        self.meas_e01_acqchn_combo.addItems(e_ch_list)

        self.meas_e02_label = QtWidgets.QLabel("EMEAS")
        self.meas_e02_id_label = QtWidgets.QLabel("ID")
        self.meas_e02_id_edit = QtWidgets.QLineEdit()
        self.meas_e02_ct_label = QtWidgets.QLabel("CHTYPE")
        self.meas_e02_ct_combo = QtWidgets.QComboBox()
        self.meas_e02_ct_combo.addItems(e_ch_list)
        self.meas_e02_x_label = QtWidgets.QLabel("X (m)")
        self.meas_e02_x_edit = QtWidgets.QLineEdit()
        self.meas_e02_y_label = QtWidgets.QLabel("Y (m)")
        self.meas_e02_y_edit = QtWidgets.QLineEdit()
        self.meas_e02_x2_label = QtWidgets.QLabel("X2 (m)")
        self.meas_e02_x2_edit = QtWidgets.QLineEdit()
        self.meas_e02_y2_label = QtWidgets.QLabel("Y2 (m)")
        self.meas_e02_y2_edit = QtWidgets.QLineEdit()
        self.meas_e02_acqchn_label = QtWidgets.QLabel("Acq. Channel")
        self.meas_e02_acqchn_combo = QtWidgets.QComboBox()
        self.meas_e02_acqchn_combo.addItems(e_ch_list)

        self.fill_meas()

        ##--> Update button
        self.update_button = QtWidgets.QPushButton("Update")
        self.update_button.pressed.connect(self.update_metadata)

        ## --> Layout
        header_layout = QtWidgets.QGridLayout()
        header_layout.addWidget(self.header_label, 0, 0)
        header_layout.addWidget(self.header_acqby_label, 1, 0)
        header_layout.addWidget(self.header_acqby_edit, 1, 1)
        header_layout.addWidget(self.header_acqdate_label, 2, 0)
        header_layout.addWidget(self.header_acqdate_edit, 2, 1)
        header_layout.addWidget(self.header_dataid_label, 3, 0)
        header_layout.addWidget(self.header_dataid_edit, 3, 1)
        header_layout.addWidget(self.header_elev_label, 4, 0)
        header_layout.addWidget(self.header_elev_edit, 4, 1)
        header_layout.addWidget(self.header_empty_label, 5, 0)
        header_layout.addWidget(self.header_empty_edit, 5, 1)
        header_layout.addWidget(self.header_fileby_label, 6, 0)
        header_layout.addWidget(self.header_fileby_edit, 6, 1)
        header_layout.addWidget(self.header_filedate_label, 7, 0)
        header_layout.addWidget(self.header_filedate_edit, 7, 1)
        header_layout.addWidget(self.header_lat_label, 8, 0)
        header_layout.addWidget(self.header_lat_edit, 8, 1)
        header_layout.addWidget(self.header_lon_label, 9, 0)
        header_layout.addWidget(self.header_lon_edit, 9, 1)
        header_layout.addWidget(self.header_loc_label, 10, 0)
        header_layout.addWidget(self.header_loc_edit, 10, 1)
        header_layout.addWidget(self.header_progdate_label, 11, 0)
        header_layout.addWidget(self.header_progdate_edit, 11, 1)
        header_layout.addWidget(self.header_progvers_label, 12, 0)
        header_layout.addWidget(self.header_progvers_edit, 12, 1)

        info_layout = QtWidgets.QVBoxLayout()
        info_layout.addWidget(self.info_label)
        info_layout.addWidget(self.info_edit)

        define_layout = QtWidgets.QGridLayout()
        define_layout.addWidget(self.define_label, 0, 0)
        define_layout.addWidget(self.define_maxchan_label, 1, 0)
        define_layout.addWidget(self.define_maxchan_edit, 1, 1)
        define_layout.addWidget(self.define_maxmeas_label, 2, 0)
        define_layout.addWidget(self.define_maxmeas_edit, 2, 1)
        define_layout.addWidget(self.define_maxrun_label, 3, 0)
        define_layout.addWidget(self.define_maxrun_edit, 3, 1)
        define_layout.addWidget(self.define_refelev_label, 4, 0)
        define_layout.addWidget(self.define_refelev_edit, 4, 1)
        define_layout.addWidget(self.define_reflat_label, 5, 0)
        define_layout.addWidget(self.define_reflat_edit, 5, 1)
        define_layout.addWidget(self.define_reflon_label, 6, 0)
        define_layout.addWidget(self.define_reflon_edit, 6, 1)
        define_layout.addWidget(self.define_reftype_label, 7, 0)
        define_layout.addWidget(self.define_reftype_edit, 7, 1)
        define_layout.addWidget(self.define_units_label, 8, 0)
        define_layout.addWidget(self.define_units_edit, 8, 1)
        # define_layout.addWidget(self.define_refloc_label, 7, 0)
        # define_layout.addWidget(self.define_refloc_edit, 7, 1)

        meas_layout = QtWidgets.QGridLayout()
        meas_layout.addWidget(self.meas_help, 0, 0, 1, 10)
        meas_layout.addWidget(self.meas_h01_label, 1, 0)
        meas_layout.addWidget(self.meas_h01_id_label, 1, 1)
        meas_layout.addWidget(self.meas_h01_id_edit, 1, 2)
        meas_layout.addWidget(self.meas_h01_ct_label, 1, 3)
        meas_layout.addWidget(self.meas_h01_ct_combo, 1, 4)
        meas_layout.addWidget(self.meas_h01_x_label, 1, 5)
        meas_layout.addWidget(self.meas_h01_x_edit, 1, 6)
        meas_layout.addWidget(self.meas_h01_y_label, 1, 7)
        meas_layout.addWidget(self.meas_h01_y_edit, 1, 8)
        meas_layout.addWidget(self.meas_h01_azm_label, 1, 9)
        meas_layout.addWidget(self.meas_h01_azm_edit, 1, 10)
        meas_layout.addWidget(self.meas_h01_acqchn_label, 1, 13)
        meas_layout.addWidget(self.meas_h01_acqchn_combo, 1, 14)

        meas_layout.addWidget(self.meas_h02_label, 2, 0)
        meas_layout.addWidget(self.meas_h02_id_label, 2, 1)
        meas_layout.addWidget(self.meas_h02_id_edit, 2, 2)
        meas_layout.addWidget(self.meas_h02_ct_label, 2, 3)
        meas_layout.addWidget(self.meas_h02_ct_combo, 2, 4)
        meas_layout.addWidget(self.meas_h02_x_label, 2, 5)
        meas_layout.addWidget(self.meas_h02_x_edit, 2, 6)
        meas_layout.addWidget(self.meas_h02_y_label, 2, 7)
        meas_layout.addWidget(self.meas_h02_y_edit, 2, 8)
        meas_layout.addWidget(self.meas_h02_azm_label, 2, 9)
        meas_layout.addWidget(self.meas_h02_azm_edit, 2, 10)
        meas_layout.addWidget(self.meas_h02_acqchn_label, 2, 13)
        meas_layout.addWidget(self.meas_h02_acqchn_combo, 2, 14)

        meas_layout.addWidget(self.meas_h03_label, 3, 0)
        meas_layout.addWidget(self.meas_h03_id_label, 3, 1)
        meas_layout.addWidget(self.meas_h03_id_edit, 3, 2)
        meas_layout.addWidget(self.meas_h03_ct_label, 3, 3)
        meas_layout.addWidget(self.meas_h03_ct_combo, 3, 4)
        meas_layout.addWidget(self.meas_h03_x_label, 3, 5)
        meas_layout.addWidget(self.meas_h03_x_edit, 3, 6)
        meas_layout.addWidget(self.meas_h03_y_label, 3, 7)
        meas_layout.addWidget(self.meas_h03_y_edit, 3, 8)
        meas_layout.addWidget(self.meas_h03_azm_label, 3, 9)
        meas_layout.addWidget(self.meas_h03_azm_edit, 3, 10)
        meas_layout.addWidget(self.meas_h03_acqchn_label, 3, 13)
        meas_layout.addWidget(self.meas_h03_acqchn_combo, 3, 14)

        meas_layout.addWidget(self.meas_hr1_label, 4, 0)
        meas_layout.addWidget(self.meas_hr1_id_label, 4, 1)
        meas_layout.addWidget(self.meas_hr1_id_edit, 4, 2)
        meas_layout.addWidget(self.meas_hr1_ct_label, 4, 3)
        meas_layout.addWidget(self.meas_hr1_ct_combo, 4, 4)
        meas_layout.addWidget(self.meas_hr1_x_label, 4, 5)
        meas_layout.addWidget(self.meas_hr1_x_edit, 4, 6)
        meas_layout.addWidget(self.meas_hr1_y_label, 4, 7)
        meas_layout.addWidget(self.meas_hr1_y_edit, 4, 8)
        meas_layout.addWidget(self.meas_hr1_azm_label, 4, 9)
        meas_layout.addWidget(self.meas_hr1_azm_edit, 4, 10)
        meas_layout.addWidget(self.meas_hr1_acqchn_label, 4, 13)
        meas_layout.addWidget(self.meas_hr1_acqchn_combo, 4, 14)

        meas_layout.addWidget(self.meas_hr2_label, 5, 0)
        meas_layout.addWidget(self.meas_hr2_id_label, 5, 1)
        meas_layout.addWidget(self.meas_hr2_id_edit, 5, 2)
        meas_layout.addWidget(self.meas_hr2_ct_label, 5, 3)
        meas_layout.addWidget(self.meas_hr2_ct_combo, 5, 4)
        meas_layout.addWidget(self.meas_hr2_x_label, 5, 5)
        meas_layout.addWidget(self.meas_hr2_x_edit, 5, 6)
        meas_layout.addWidget(self.meas_hr2_y_label, 5, 7)
        meas_layout.addWidget(self.meas_hr2_y_edit, 5, 8)
        meas_layout.addWidget(self.meas_hr2_azm_label, 5, 9)
        meas_layout.addWidget(self.meas_hr2_azm_edit, 5, 10)
        meas_layout.addWidget(self.meas_hr2_acqchn_label, 5, 13)
        meas_layout.addWidget(self.meas_hr2_acqchn_combo, 5, 14)

        meas_layout.addWidget(self.meas_e01_label, 6, 0)
        meas_layout.addWidget(self.meas_e01_id_label, 6, 1)
        meas_layout.addWidget(self.meas_e01_id_edit, 6, 2)
        meas_layout.addWidget(self.meas_e01_ct_label, 6, 3)
        meas_layout.addWidget(self.meas_e01_ct_combo, 6, 4)
        meas_layout.addWidget(self.meas_e01_x_label, 6, 5)
        meas_layout.addWidget(self.meas_e01_x_edit, 6, 6)
        meas_layout.addWidget(self.meas_e01_y_label, 6, 7)
        meas_layout.addWidget(self.meas_e01_y_edit, 6, 8)
        meas_layout.addWidget(self.meas_e01_x2_label, 6, 9)
        meas_layout.addWidget(self.meas_e01_x2_edit, 6, 10)
        meas_layout.addWidget(self.meas_e01_y2_label, 6, 11)
        meas_layout.addWidget(self.meas_e01_y2_edit, 6, 12)
        meas_layout.addWidget(self.meas_e01_acqchn_label, 6, 13)
        meas_layout.addWidget(self.meas_e01_acqchn_combo, 6, 14)

        meas_layout.addWidget(self.meas_e02_label, 7, 0)
        meas_layout.addWidget(self.meas_e02_id_label, 7, 1)
        meas_layout.addWidget(self.meas_e02_id_edit, 7, 2)
        meas_layout.addWidget(self.meas_e02_ct_label, 7, 3)
        meas_layout.addWidget(self.meas_e02_ct_combo, 7, 4)
        meas_layout.addWidget(self.meas_e02_x_label, 7, 5)
        meas_layout.addWidget(self.meas_e02_x_edit, 7, 6)
        meas_layout.addWidget(self.meas_e02_y_label, 7, 7)
        meas_layout.addWidget(self.meas_e02_y_edit, 7, 8)
        meas_layout.addWidget(self.meas_e02_x2_label, 7, 9)
        meas_layout.addWidget(self.meas_e02_x2_edit, 7, 10)
        meas_layout.addWidget(self.meas_e02_y2_label, 7, 11)
        meas_layout.addWidget(self.meas_e02_y2_edit, 7, 12)
        meas_layout.addWidget(self.meas_e02_acqchn_label, 7, 13)
        meas_layout.addWidget(self.meas_e02_acqchn_combo, 7, 14)

        v_layout = QtWidgets.QVBoxLayout()
        v_layout.addLayout(header_layout)
        v_layout.addLayout(define_layout)

        h_layout = QtWidgets.QHBoxLayout()
        h_layout.addLayout(v_layout)
        h_layout.addLayout(info_layout)

        final_layout = QtWidgets.QVBoxLayout()
        final_layout.addLayout(h_layout)
        final_layout.addLayout(meas_layout)
        final_layout.addWidget(self.update_button)

        self.setLayout(final_layout)

        self.show()

        # center the window, needs to go after show()
        self.center_window()

    def center_window(self):
        screen_center = QtWidgets.QDesktopWidget().availableGeometry().center()
        widget_size = self.frameGeometry()

        widget_size.moveCenter(screen_center)

        self.move(widget_size.topLeft())

    def header_set_acqby(self):
        self.mt_obj.Header.acqby = str(self.header_acqby_edit.text())
        self.header_acqby_edit.setText(self.mt_obj.Header.acqby)

    def header_set_acqdate(self):
        self.mt_obj.Header.acqdate = str(self.header_acqdate_edit.text())
        self.header_acqdate_edit.setText(self.mt_obj.Header.acqdate)

    def header_set_dataid(self):
        self.mt_obj.Header.dataid = str(self.header_dataid_edit.text())
        self.header_dataid_edit.setText(self.mt_obj.Header.dataid)

    def header_set_elev(self):
        self.mt_obj.elev = float(str(self.header_elev_edit.text()))
        self.header_elev_edit.setText("{0:.1f}".format(self.mt_obj.elev))

    def header_set_empty(self):
        self.mt_obj.Header.empty = float(str(self.header_empty_edit.text()))
        self.header_empty_edit.setText(
            "{0:.2e}".format(self.mt_obj.Header.empty)
        )

    def header_set_fileby(self):
        self.mt_obj.Header.fileby = str(self.header_fileby_edit.text())
        self.header_fileby_edit.setText(
            "{0}".format(self.mt_obj.Header.fileby)
        )

    def header_set_filedate(self):
        self.mt_obj.Header.filedate = str(self.header_filedate_edit.text())
        self.header_filedate_edit.setText(
            "{0}".format(self.mt_obj.Header.filedate)
        )

    def header_set_lat(self):
        self.mt_obj.lat = str(self.header_lat_edit.text())
        self.header_lat_edit.setText("{0:.5f}".format(self.mt_obj.lat))

    def header_set_lon(self):
        self.mt_obj.lon = str(self.header_lon_edit.text())
        self.header_lon_edit.setText("{0:.5f}".format(self.mt_obj.lon))

    def header_set_loc(self):
        self.mt_obj.Header.loc = str(self.header_loc_edit.text())
        self.header_loc_edit.setText("{0}".format(self.mt_obj.Header.loc))

    def header_set_progdate(self):
        self.mt_obj.Header.progdate = str(self.header_progdate_edit.text())
        self.header_progdate_edit.setText(
            "{0}".format(self.mt_obj.Header.progdate)
        )

    def header_set_progvers(self):
        self.mt_obj.Header.progvers = str(self.header_progvers_edit.text())
        self.header_progvers_edit.setText(
            "{0}".format(self.mt_obj.Header.progvers)
        )

    def info_set_text(self):
        new_info_str = self.info_edit.toPlainText()
        new_info_list = [str(nn) for nn in new_info_str.split("\n")]
        self.mt_obj.Info.info_list = self.mt_obj.Info._validate_info_list(
            new_info_list
        )

    def define_set_maxchan(self):
        self.mt_obj.Define_measurement.maxchan = int(
            str(self.define_maxchan_edit.text())
        )
        self.define_maxchan_edit.setText(
            "{0}".format(self.mt_obj.Define_measurement.maxchan)
        )

    def define_set_maxrun(self):
        self.mt_obj.Define_measurement.maxrun = int(
            str(self.define_maxrun_edit.text())
        )
        self.define_maxrun_edit.setText(
            "{0}".format(self.mt_obj.Define_measurement.maxrun)
        )

    def define_set_maxmeas(self):
        self.mt_obj.Define_measurement.maxmeas = int(
            str(self.define_maxmeas_edit.text())
        )
        self.define_maxmeas_edit.setText(
            "{0}".format(self.mt_obj.Define_measurement.maxmeas)
        )

    def define_set_reftype(self):
        self.mt_obj.Define_measurement.reftype = str(
            self.define_reftype_edit.text()
        )
        self.define_reftype_edit.setText(
            "{0}".format(self.mt_obj.Define_measurement.reftype)
        )

    def define_set_units(self):
        self.mt_obj.Define_measurement.units = str(
            self.define_units_edit.text()
        )
        self.define_units_edit.setText(
            "{0}".format(self.mt_obj.Define_measurement.units)
        )

    def fill_meas(self):

        if hasattr(self.mt_obj.Define_measurement, "meas_hx"):
            self.meas_h01_id_edit.setText(
                "{0}".format(self.mt_obj.Define_measurement.meas_hx.id)
            )
            self.meas_h01_azm_edit.setText(
                "{0:.2f}".format(
                    self._check_float(
                        self.mt_obj.Define_measurement.meas_hx.azm
                    )
                )
            )
            self.meas_h01_x_edit.setText(
                "{0:.2f}".format(
                    self._check_float(self.mt_obj.Define_measurement.meas_hx.x)
                )
            )
            self.meas_h01_y_edit.setText(
                "{0:.2f}".format(
                    self._check_float(self.mt_obj.Define_measurement.meas_hx.y)
                )
            )
            self.meas_h01_ct_combo.setCurrentIndex(0)
            self.meas_h01_acqchn_combo.setCurrentIndex(0)

        if hasattr(self.mt_obj.Define_measurement, "meas_hy"):
            self.meas_h02_id_edit.setText(
                "{0}".format(self.mt_obj.Define_measurement.meas_hy.id)
            )
            self.meas_h02_azm_edit.setText(
                "{0:.2f}".format(
                    self._check_float(
                        self.mt_obj.Define_measurement.meas_hy.azm
                    )
                )
            )
            self.meas_h02_x_edit.setText(
                "{0:.2f}".format(
                    self._check_float(self.mt_obj.Define_measurement.meas_hy.x)
                )
            )
            self.meas_h02_y_edit.setText(
                "{0:.2f}".format(
                    self._check_float(self.mt_obj.Define_measurement.meas_hy.y)
                )
            )
            self.meas_h02_ct_combo.setCurrentIndex(1)
            self.meas_h02_acqchn_combo.setCurrentIndex(1)

        if hasattr(self.mt_obj.Define_measurement, "meas_hz"):
            self.meas_h03_id_edit.setText(
                "{0}".format(self.mt_obj.Define_measurement.meas_hz.id)
            )
            self.meas_h03_azm_edit.setText(
                "{0:.2f}".format(
                    self._check_float(
                        self.mt_obj.Define_measurement.meas_hz.azm
                    )
                )
            )
            self.meas_h03_x_edit.setText(
                "{0:.2f}".format(
                    self._check_float(self.mt_obj.Define_measurement.meas_hz.x)
                )
            )
            self.meas_h03_y_edit.setText(
                "{0:.2f}".format(
                    self._check_float(self.mt_obj.Define_measurement.meas_hz.y)
                )
            )
            self.meas_h03_ct_combo.setCurrentIndex(2)
            self.meas_h03_acqchn_combo.setCurrentIndex(2)

        if hasattr(self.mt_obj.Define_measurement, "meas_rhx"):
            self.meas_hr1_id_edit.setText(
                "{0}".format(self.mt_obj.Define_measurement.meas_rhx.id)
            )
            self.meas_hr1_azm_edit.setText(
                "{0:.2f}".format(
                    self._check_float(
                        self.mt_obj.Define_measurement.meas_rhx.azm
                    )
                )
            )
            self.meas_hr1_x_edit.setText(
                "{0:.2f}".format(
                    self._check_float(
                        self.mt_obj.Define_measurement.meas_rhx.x
                    )
                )
            )
            self.meas_hr1_y_edit.setText(
                "{0:.2f}".format(
                    self._check_float(
                        self.mt_obj.Define_measurement.meas_rhx.y
                    )
                )
            )
            self.meas_hr1_ct_combo.setCurrentIndex(3)
            self.meas_hr1_acqchn_combo.setCurrentIndex(3)

        if hasattr(self.mt_obj.Define_measurement, "meas_rhy"):
            self.meas_hr2_id_edit.setText(
                "{0}".format(self.mt_obj.Define_measurement.meas_rhy.id)
            )
            self.meas_hr2_azm_edit.setText(
                "{0:.2f}".format(
                    self._check_float(
                        self.mt_obj.Define_measurement.meas_rhy.azm
                    )
                )
            )
            self.meas_hr2_x_edit.setText(
                "{0:.2f}".format(
                    self._check_float(
                        self.mt_obj.Define_measurement.meas_rhy.x
                    )
                )
            )
            self.meas_hr2_y_edit.setText(
                "{0:.2f}".format(
                    self._check_float(
                        self.mt_obj.Define_measurement.meas_rhy.y
                    )
                )
            )
            self.meas_hr2_ct_combo.setCurrentIndex(4)
            self.meas_hr2_acqchn_combo.setCurrentIndex(4)

        if hasattr(self.mt_obj.Define_measurement, "meas_ex"):
            self.meas_e01_id_edit.setText(
                "{0}".format(self.mt_obj.Define_measurement.meas_ex.id)
            )
            self.meas_e01_x_edit.setText(
                "{0:.2f}".format(
                    self._check_float(self.mt_obj.Define_measurement.meas_ex.x)
                )
            )
            self.meas_e01_y_edit.setText(
                "{0:.2f}".format(
                    self._check_float(self.mt_obj.Define_measurement.meas_ex.y)
                )
            )
            self.meas_e01_x2_edit.setText(
                "{0:.2f}".format(
                    self._check_float(
                        self.mt_obj.Define_measurement.meas_ex.x2
                    )
                )
            )
            self.meas_e01_y2_edit.setText(
                "{0:.2f}".format(
                    self._check_float(
                        self.mt_obj.Define_measurement.meas_ex.y2
                    )
                )
            )
            self.meas_e01_ct_combo.setCurrentIndex(0)
            self.meas_e01_acqchn_combo.setCurrentIndex(0)

        if hasattr(self.mt_obj.Define_measurement, "meas_ey"):
            self.meas_e02_id_edit.setText(
                "{0}".format(self.mt_obj.Define_measurement.meas_ey.id)
            )
            self.meas_e02_x_edit.setText(
                "{0:.2f}".format(
                    self._check_float(self.mt_obj.Define_measurement.meas_ey.x)
                )
            )
            self.meas_e02_y_edit.setText(
                "{0:.2f}".format(
                    self._check_float(self.mt_obj.Define_measurement.meas_ey.y)
                )
            )
            self.meas_e02_x2_edit.setText(
                "{0:.2f}".format(
                    self._check_float(
                        self.mt_obj.Define_measurement.meas_ey.x2
                    )
                )
            )
            self.meas_e02_y2_edit.setText(
                "{0:.2f}".format(
                    self._check_float(
                        self.mt_obj.Define_measurement.meas_ey.y2
                    )
                )
            )
            self.meas_e02_ct_combo.setCurrentIndex(1)
            self.meas_e02_acqchn_combo.setCurrentIndex(1)

    def _check_float(self, value):
        try:
            return_num = float(value)
        except ValueError:
            return_num = 0.0

        return return_num

    def update_metadata(self):
        self.metadata_updated.emit()
        self.close()


# ==============================================================================
# Def Main
# ==============================================================================
def main():
    app = QtWidgets.QApplication(sys.argv)
    ui = MTEditorWindow()
    ui.ui_setup()
    ui.show()
    sys.exit(app.exec_())


if __name__ == "__main__":
    main()
